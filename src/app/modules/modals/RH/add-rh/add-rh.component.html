<!-- Backdrop -->
<div
    class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
    <!-- MODAL -->
    <div
        class="animate-fadeIn flex h-full w-full flex-col overflow-hidden rounded-none bg-white shadow-xl sm:h-auto sm:max-h-[90vh] sm:max-w-lg sm:rounded-2xl dark:bg-gray-900"
    >
        <!-- HEADER -->
        <header
            class="sticky top-0 z-10 flex items-center justify-between border-b border-gray-200 bg-white px-4 py-3 dark:border-gray-700 dark:bg-gray-900"
        >
            <h2 class="text-lg font-semibold">Crear Superadmin</h2>
            <button
                class="rounded-full p-2 hover:bg-gray-100 dark:hover:bg-gray-800"
                (click)="closeModal()"
                [disabled]="isLoading"
            >
                ✕
            </button>
        </header>

        <!-- Loading Bar -->
        @if (isLoading) {
            <mat-progress-bar [mode]="'indeterminate'"></mat-progress-bar>
        }

        <!-- CONTENIDO SCROLLEABLE -->
        <div class="flex-1 space-y-6 overflow-y-auto p-4">
            <!-- Avatar -->
            <div class="flex flex-col items-center">
                <div class="relative">
                    <img
                        class="h-32 w-32 rounded-full border object-cover shadow"
                        [src]="newPhotoUrl"
                    />

                    <div
                        class="absolute inset-0 flex cursor-pointer items-center justify-center rounded-full bg-black/40 opacity-0 transition-opacity hover:opacity-100"
                        (click)="fileInput.click()"
                    >
                        <mat-icon
                            class="text-white"
                            svgIcon="heroicons_outline:camera"
                        ></mat-icon>
                    </div>

                    <input
                        #fileInput
                        type="file"
                        accept="image/*"
                        class="hidden"
                        (change)="onPhotoSelected($event)"
                    />
                </div>

                <!-- Botón solo visible en móvil -->
                <button
                    class="mt-3 block rounded-lg bg-gray-200 px-3 py-1 hover:bg-gray-300 sm:hidden dark:bg-gray-800 dark:hover:bg-gray-700"
                    (click)="fileInput.click()"
                >
                    Cambiar foto
                </button>
            </div>

            <!-- Formulario -->
            <form
                class="flex flex-col gap-8"
                [formGroup]="newUsuarioForm"
                autocomplete="off"
                autocorrect="off"
                autocapitalize="off"
                spellcheck="false"
            >
                <!-- ░░ SECTION 1: Datos personales ░░ -->
                <div class="space-y-3">
                    <h3
                        class="text-lg font-semibold text-gray-700 dark:text-gray-300"
                    >
                        Datos personales
                    </h3>

                    <mat-form-field class="w-full">
                        <mat-label>Nombre</mat-label>
                        <input
                            matInput
                            formControlName="name"
                            placeholder="Nombre completo"
                            maxlength="35"
                            autocomplete="off"
                        />
                        <mat-error
                            *ngIf="
                                newUsuarioForm.get('name')?.touched &&
                                newUsuarioForm.get('name')?.hasError('required')
                            "
                        >
                            El nombre es obligatorio.
                        </mat-error>
                    </mat-form-field>

                    <mat-form-field class="w-full">
                        <mat-label>Correo electrónico</mat-label>
                        <input
                            matInput
                            type="email"
                            formControlName="email"
                            placeholder="correo@ejemplo.com"
                               maxlength="40"
                        />
                        <mat-error
                            *ngIf="
                                newUsuarioForm.get('email')?.touched &&
                                newUsuarioForm
                                    .get('email')
                                    ?.hasError('required')
                            "
                        >
                            El correo es obligatorio.
                        </mat-error>
                        <mat-error
                            *ngIf="
                                newUsuarioForm.get('email')?.touched &&
                                newUsuarioForm.get('email')?.hasError('email')
                            "
                        >
                            Introduce un correo válido.
                        </mat-error>
                    </mat-form-field>
                </div>

                <!-- ░░ SECTION 2: Datos administrativos ░░ -->
                <div class="space-y-3">
                    <h3
                        class="text-lg font-semibold text-gray-700 dark:text-gray-300"
                    >
                        Datos administrativos
                    </h3>

                    <mat-form-field class="w-full">
                        <mat-label>Departamento</mat-label>
                        <input
                            matInput
                            formControlName="departamento"
                               maxlength="25"
                            placeholder="Departamento"
                        />
                    </mat-form-field>

                    <mat-form-field class="w-full">
                        <mat-label>Desktop</mat-label>
                        <input
                            matInput
                            formControlName="desktop"
                               maxlength="25"
                            placeholder="Desktop"
                        />
                    </mat-form-field>
                </div>

<!-- ░░ SECTION 3: Credenciales ░░ -->
<div class="space-y-3">
    <h3
        class="text-lg font-semibold text-gray-700 dark:text-gray-300"
    >
        Credenciales de acceso
    </h3>

    <mat-form-field class="w-full">
        <mat-label>Usuario</mat-label>
        <input
            matInput
            formControlName="usuario"
            placeholder="Usuario"
            autocomplete="new-password"
            readonly
               maxlength="18"
            onfocus="this.removeAttribute('readonly');"
        />
        <mat-error
            *ngIf="
                newUsuarioForm.get('usuario')?.touched &&
                newUsuarioForm
                    .get('usuario')
                    ?.hasError('required')
            "
        >
            El usuario es obligatorio.
        </mat-error>
    </mat-form-field>

    <mat-form-field class="w-full">
        <mat-label>Contraseña</mat-label>
        <input
            matInput
            [type]="showPassword ? 'text' : 'password'"
            formControlName="password"
            placeholder="Contraseña"
            autocomplete="new-password"
            readonly
               maxlength="16"
            onfocus="this.removeAttribute('readonly');"
        />
        <button
            mat-icon-button
            matSuffix
            type="button"
            (click)="togglePasswordVisibility()"
        >
            <mat-icon
                [svgIcon]="
                    showPassword
                        ? 'heroicons_outline:eye-slash'
                        : 'heroicons_outline:eye'
                "
            ></mat-icon>
        </button>
        <mat-error
            *ngIf="
                newUsuarioForm.get('password')?.touched &&
                newUsuarioForm
                    .get('password')
                    ?.hasError('required')
            "
        >
            La contraseña es obligatoria.
        </mat-error>
        <mat-error
            *ngIf="
                newUsuarioForm.get('password')?.touched &&
                newUsuarioForm
                    .get('password')
                    ?.hasError('minlength')
            "
        >
            La contraseña debe tener al menos 6 caracteres.
        </mat-error>
    </mat-form-field>

    <!-- Password Strength Bar -->
    @if (newUsuarioForm.get('password')?.value) {
        <div class="mb-4">
            <div class="mb-1 flex items-center justify-between">
                <span
                    class="text-sm text-gray-600 dark:text-gray-400"
                    >Seguridad de la contraseña:</span
                >
                <span
                    class="text-sm font-medium"
                    [ngClass]="{
                        'text-red-600':
                            passwordStrengthColor === 'warn',
                        'text-yellow-600':
                            passwordStrengthColor === 'accent',
                        'text-green-600':
                            passwordStrengthColor === 'primary',
                    }"
                    >{{ passwordStrengthLabel }}</span
                >
            </div>
            <mat-progress-bar
                [mode]="'determinate'"
                [value]="passwordStrength"
                [color]="passwordStrengthColor"
            ></mat-progress-bar>
        </div>
    }

    <mat-form-field class="w-full">
        <mat-label>Confirmar contraseña</mat-label>
        <input
            matInput
            [type]="
                showPasswordConfirmation ? 'text' : 'password'
            "
            formControlName="password_confirmation"
            placeholder="Repite la contraseña"
            autocomplete="new-password"
            readonly
            onfocus="this.removeAttribute('readonly');"
            (paste)="blockPaste($event)"
            maxlength="16"
        />
        <button
            mat-icon-button
            matSuffix
            type="button"
            (click)="togglePasswordConfirmationVisibility()"
        >
            <mat-icon
                [svgIcon]="
                    showPasswordConfirmation
                        ? 'heroicons_outline:eye-slash'
                        : 'heroicons_outline:eye'
                "
            ></mat-icon>
        </button>
        <mat-error
            *ngIf="
                newUsuarioForm.get('password_confirmation')
                    ?.touched &&
                newUsuarioForm
                    .get('password_confirmation')
                    ?.hasError('required')
            "
        >
            Debes repetir la contraseña.
        </mat-error>
    </mat-form-field>

    <!-- Password Match Indicator -->
    @if (newUsuarioForm.get('password_confirmation')?.value) {
        <div class="mt-2 flex items-center gap-2">
            @if (passwordsMatch()) {
                <mat-icon
                    class="text-green-600"
                    svgIcon="heroicons_outline:check-circle"
                ></mat-icon>
                <span class="text-sm text-green-600"
                    >Las contraseñas coinciden</span
                >
            }
            @if (passwordsDontMatch()) {
                <div
                    class="flex items-center gap-2 text-red-600"
                >
                    <mat-icon
                        svgIcon="heroicons_outline:x-circle"
                    ></mat-icon>
                    <span class="text-sm font-medium"
                        >Las contraseñas no coinciden</span
                    >
                </div>
            }
        </div>
    }
</div>
            </form>
        </div>

        <!-- FOOTER FIJO -->
        <footer
            class="sticky bottom-0 flex items-center justify-end space-x-3 border-t border-gray-200 bg-white px-4 py-3 dark:border-gray-700 dark:bg-gray-900"
        >
            <button
                class="rounded-lg bg-gray-200 px-4 py-2 hover:bg-gray-300 dark:bg-gray-800 dark:hover:bg-gray-700"
                (click)="closeModal()"
                [disabled]="isLoading"
            >
                Cancelar
            </button>

            <button
                class="rounded-lg bg-blue-600 px-4 py-2 text-white hover:bg-blue-700 disabled:cursor-not-allowed disabled:opacity-50"
                (click)="submitForm()"
                [disabled]="isLoading"
            >
                @if (isLoading) {
                    <span>Guardando...</span>
                } @else {
                    <span>Guardar</span>
                }
            </button>
        </footer>
    </div>
</div>
