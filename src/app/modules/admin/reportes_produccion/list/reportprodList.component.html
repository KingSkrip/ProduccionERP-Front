<div class="absolute inset-0 flex flex-col min-w-0 overflow-hidden bg-card dark:bg-transparent">

    <!-- ===== HEADER ===== -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between py-2 px-6 sm:px-8 border-b">
        <div class="flex items-center gap-4">
            <div class="flex items-center justify-center w-12 h-12 rounded-full bg-primary/10">
                <mat-icon class="text-primary icon-size-6" [svgIcon]="'heroicons_solid:chart-bar'"></mat-icon>
            </div>
            <div>
                <div class="text-3xl font-extrabold tracking-tight leading-none">Reportes de producción</div>
                <div class="text-sm text-secondary mt-1">Analiza la producción por departamento y proceso</div>
            </div>
        </div>
    </div>

    <!-- ===== FILTROS MÓVIL ===== -->
    <div class="md:hidden">
        <div class="sticky top-0 z-40 bg-card border-b shadow-sm">
            <div class="flex items-center gap-3 pr-4">
                <mat-form-field class="fuse-mat-dense fuse-mat-rounded-lg flex-1 border-none" appearance="outline"
                    [subscriptSizing]="'dynamic'">
                    <mat-icon matPrefix class="text-hint" [svgIcon]="'heroicons_solid:magnifying-glass'"></mat-icon>
                    <input matInput [formControl]="searchControl" [autocomplete]="'off'" placeholder="Buscar...">
                </mat-form-field>

                <button mat-icon-button color="primary" class="relative" (click)="togglePanelFiltros()"
                    [matBadge]="filtrosActivosCount()" matBadgeSize="small" matBadgeColor="accent"
                    [matBadgeHidden]="filtrosActivosCount() === 0">
                    <mat-icon [svgIcon]="'heroicons_solid:adjustments-horizontal'"></mat-icon>
                </button>
            </div>
        </div>

        <!-- Panel completo de filtros móvil -->
        <div *ngIf="mostrarPanelFiltros" class="fixed inset-0 z-50 flex flex-col bg-card">
            <div class="flex items-center justify-between p-5 border-b sticky top-0 bg-card z-10 shadow-sm">
                <h2 class="text-xl font-bold">Filtros avanzados</h2>
                <button mat-icon-button (click)="togglePanelFiltros()">
                    <mat-icon [svgIcon]="'heroicons_solid:x-mark'"></mat-icon>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-5 space-y-6">
                <div>
                    <button mat-stroked-button class="w-full mt-15 h-14 px-5 justify-between rounded-xl border-2 
                               hover:border-primary transition-all font-medium" (click)="toggleDatePanel()">
                        <div class="flex items-center gap-3">
                            <mat-icon class="text-primary" [svgIcon]="'heroicons_solid:calendar-days'"></mat-icon>
                            <span class="truncate">{{ obtenerTextoFechaSeleccionada() }}</span>
                        </div>
                        <mat-icon [svgIcon]="'heroicons_solid:chevron-down'" class="transition-transform duration-200"
                            [ngClass]="{'rotate-180': mostrarPanelFechas}"></mat-icon>
                    </button>

                    <div *ngIf="mostrarPanelFechas"
                        class="fixed inset-4 top-20 bg-card rounded-2xl shadow-2xl border z-50 overflow-hidden flex flex-col">
                        <div class="p-5 border-b bg-card">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <mat-icon class="text-primary"
                                        [svgIcon]="'heroicons_solid:calendar-days'"></mat-icon>
                                    <h3 class="text-lg font-bold">Filtrar por fechas</h3>
                                </div>
                                <div class="flex items-center gap-3">
                                    <button mat-button color="primary" (click)="limpiarFiltroFechas()">Limpiar</button>
                                    <button mat-icon-button (click)="toggleDatePanel()">
                                        <mat-icon [svgIcon]="'heroicons_solid:x-mark'"></mat-icon>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="flex-1 overflow-y-auto p-5">
                            <div class="grid grid-cols-2 gap-3">
                                <button mat-flat-button class="h-12 rounded-xl justify-between col-span-2 border-2"
                                    [ngClass]="{
                                        'bg-primary border-primary text-white': rangoFechaSeleccionado === 'todos',
                                        'border-default': rangoFechaSeleccionado !== 'todos'
                                    }" (click)="seleccionarRangoFecha('todos')">
                                    Ver todos
                                    <mat-icon *ngIf="rangoFechaSeleccionado === 'todos'"
                                        [svgIcon]="'heroicons_solid:check'"></mat-icon>
                                </button>

                                <button mat-flat-button class="h-12 rounded-xl justify-between border-2" [ngClass]="{
                                        'bg-primary border-primary text-white': rangoFechaSeleccionado === 'hoy',
                                        'border-default': rangoFechaSeleccionado !== 'hoy'
                                    }" (click)="seleccionarRangoFecha('hoy')">
                                    Hoy
                                    <mat-icon *ngIf="rangoFechaSeleccionado === 'hoy'"
                                        [svgIcon]="'heroicons_solid:check'"></mat-icon>
                                </button>

                                <button mat-flat-button class="h-12 rounded-xl justify-between border-2" [ngClass]="{
                                        'bg-primary border-primary text-white': rangoFechaSeleccionado === 'ayer',
                                        'border-default': rangoFechaSeleccionado !== 'ayer'
                                    }" (click)="seleccionarRangoFecha('ayer')">
                                    Ayer
                                    <mat-icon *ngIf="rangoFechaSeleccionado === 'ayer'"
                                        [svgIcon]="'heroicons_solid:check'"></mat-icon>
                                </button>

                                <button mat-flat-button class="h-12 rounded-xl justify-between border-2" [ngClass]="{
                                        'bg-primary border-primary text-white': rangoFechaSeleccionado === 'mes_actual',
                                        'border-default': rangoFechaSeleccionado !== 'mes_actual'
                                    }" (click)="seleccionarRangoFecha('mes_actual')">
                                    Mes actual
                                    <mat-icon *ngIf="rangoFechaSeleccionado === 'mes_actual'"
                                        [svgIcon]="'heroicons_solid:check'"></mat-icon>
                                </button>

                                <button mat-flat-button class="h-12 rounded-xl justify-between border-2" [ngClass]="{
                                        'bg-primary border-primary text-white': rangoFechaSeleccionado === 'mes_anterior',
                                        'border-default': rangoFechaSeleccionado !== 'mes_anterior'
                                    }" (click)="seleccionarRangoFecha('mes_anterior')">
                                    Mes anterior
                                    <mat-icon *ngIf="rangoFechaSeleccionado === 'mes_anterior'"
                                        [svgIcon]="'heroicons_solid:check'"></mat-icon>
                                </button>

                                <button mat-stroked-button class="h-12 rounded-xl border-2" [ngClass]="{
                                        'border-primary text-primary bg-primary/10': rangoFechaSeleccionado === 'fecha_especifica'
                                    }" (click)="seleccionarRangoFecha('fecha_especifica')">
                                    Fecha específica
                                </button>

                                <button mat-stroked-button class="h-12 rounded-xl border-2" [ngClass]="{
                                        'border-primary text-primary bg-primary/10': rangoFechaSeleccionado === 'periodo'
                                    }" (click)="seleccionarRangoFecha('periodo')">
                                    Periodo
                                </button>
                            </div>

                            <div *ngIf="rangoFechaSeleccionado === 'fecha_especifica'" class="mt-6 space-y-4">
                                <h4 class="font-semibold text-primary">Selecciona una fecha</h4>
                                <mat-form-field class="w-full" appearance="outline">
                                    <input matInput [matDatepicker]="pickerMovilUnica"
                                        [formControl]="fechaInicioControl">
                                    <mat-datepicker-toggle matIconSuffix
                                        [for]="pickerMovilUnica"></mat-datepicker-toggle>
                                    <mat-datepicker #pickerMovilUnica touchUi></mat-datepicker>
                                </mat-form-field>
                                <button mat-flat-button color="primary" class="w-full h-14 rounded-full text-lg"
                                    (click)="aplicarFiltroFechas()">
                                    <mat-icon class="mr-2" [svgIcon]="'heroicons_solid:check'"></mat-icon>
                                    Aplicar
                                </button>
                            </div>

                            <div *ngIf="rangoFechaSeleccionado === 'periodo'" class="mt-6 space-y-4">
                                <h4 class="font-semibold text-primary">Rango personalizado</h4>
                                <mat-form-field class="w-full" appearance="outline">
                                    <mat-label>Fecha Desde</mat-label>
                                    <input matInput [matDatepicker]="pickerMovilInicio"
                                        [formControl]="fechaInicioControl">
                                    <mat-datepicker-toggle matIconSuffix
                                        [for]="pickerMovilInicio"></mat-datepicker-toggle>
                                    <mat-datepicker #pickerMovilInicio touchUi></mat-datepicker>
                                </mat-form-field>
                                <mat-form-field class="w-full" appearance="outline">
                                    <mat-label>Fecha Hasta</mat-label>
                                    <input matInput [matDatepicker]="pickerMovilFin" [formControl]="fechaFinControl">
                                    <mat-datepicker-toggle matIconSuffix [for]="pickerMovilFin"></mat-datepicker-toggle>
                                    <mat-datepicker #pickerMovilFin touchUi></mat-datepicker>
                                </mat-form-field>
                                <button mat-flat-button color="primary" class="w-full h-14 rounded-full text-lg"
                                    (click)="aplicarFiltroFechas()">
                                    <mat-icon class="mr-2" [svgIcon]="'heroicons_solid:check'"></mat-icon>
                                    Aplicar rango
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <mat-form-field class="w-full" appearance="outline">
                    <mat-icon matPrefix class="text-primary" [svgIcon]="'heroicons_solid:building-office-2'"></mat-icon>
                    <mat-label>Departamento</mat-label>
                    <mat-select [formControl]="deptoControl">
                        <mat-option [value]="''">Todos los departamentos</mat-option>
                        <mat-option *ngFor="let depto of departamentosUnicos" [value]="depto">{{ depto }}</mat-option>
                    </mat-select>
                </mat-form-field>
            </div>

            <div class="p-5 border-t bg-card space-y-3">
                <button mat-stroked-button class="w-full h-12 rounded-xl"
                    (click)="limpiarTodosFiltros(); togglePanelFiltros()">
                    Limpiar filtros
                </button>
            </div>
        </div>
    </div>

    <!-- ===== FILTROS PC ===== -->
    <div class="hidden md:block">
        <div class="flex flex-col gap-3 p-6 md:px-8 border-b bg-gray-50 dark:bg-gray-900/50">
            <div class="flex gap-3">
                <div class="relative">
                    <button mat-stroked-button class="h-10 px-4 min-w-64" (click)="toggleDatePanel()">
                        <mat-icon class="icon-size-5 mr-2" [svgIcon]="'heroicons_solid:calendar'"></mat-icon>
                        <span class="text-sm truncate">{{ obtenerTextoFechaSeleccionada() }}</span>
                        <mat-icon class="icon-size-4 ml-auto" [svgIcon]="'heroicons_solid:chevron-down'"></mat-icon>
                    </button>

                    <div *ngIf="mostrarPanelFechas"
                        class="absolute top-full left-0 mt-2 bg-card rounded-lg shadow-2xl border z-50 w-96 overflow-hidden">
                        <div class="p-4 border-b flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <mat-icon class="text-primary" [svgIcon]="'heroicons_solid:calendar'"></mat-icon>
                                <h3 class="font-semibold">Filtrar por fechas</h3>
                            </div>
                            <div class="flex gap-2">
                                <button mat-button class="text-primary" (click)="limpiarFiltroFechas()">Limpiar</button>
                                <button mat-icon-button (click)="toggleDatePanel()">
                                    <mat-icon [svgIcon]="'heroicons_solid:x-mark'"></mat-icon>
                                </button>
                            </div>
                        </div>

                        <div class="p-4">
                            <div class="grid grid-cols-2 gap-2">
                                <button mat-flat-button class="h-12 rounded-lg col-span-2 border-2" [ngClass]="{
                                        'bg-primary border-primary text-white': rangoFechaSeleccionado === 'todos'
                                    }" (click)="seleccionarRangoFecha('todos')">
                                    <span class="flex-1 text-left">Ver todos</span>
                                    <mat-icon *ngIf="rangoFechaSeleccionado === 'todos'"
                                        [svgIcon]="'heroicons_solid:check'"></mat-icon>
                                </button>

                                <button mat-button class="h-12 rounded-lg border-2" [ngClass]="{
                                        'bg-primary border-primary text-white': rangoFechaSeleccionado === 'hoy'
                                    }" (click)="seleccionarRangoFecha('hoy')">
                                    <span class="flex-1 text-left">Hoy</span>
                                    <mat-icon *ngIf="rangoFechaSeleccionado === 'hoy'"
                                        [svgIcon]="'heroicons_solid:check'"></mat-icon>
                                </button>

                                <button mat-button class="h-12 rounded-lg border-2" [ngClass]="{
                                        'bg-primary border-primary text-white': rangoFechaSeleccionado === 'ayer'
                                    }" (click)="seleccionarRangoFecha('ayer')">
                                    <span class="flex-1 text-left">Ayer</span>
                                    <mat-icon *ngIf="rangoFechaSeleccionado === 'ayer'"
                                        [svgIcon]="'heroicons_solid:check'"></mat-icon>
                                </button>

                                <button mat-button class="h-12 rounded-lg border-2" [ngClass]="{
                                        'bg-primary border-primary text-white': rangoFechaSeleccionado === 'mes_actual'
                                    }" (click)="seleccionarRangoFecha('mes_actual')">
                                    <span class="flex-1 text-left">Mes actual</span>
                                    <mat-icon *ngIf="rangoFechaSeleccionado === 'mes_actual'"
                                        [svgIcon]="'heroicons_solid:check'"></mat-icon>
                                </button>

                                <button mat-button class="h-12 rounded-lg border-2" [ngClass]="{
                                        'bg-primary border-primary text-white': rangoFechaSeleccionado === 'mes_anterior'
                                    }" (click)="seleccionarRangoFecha('mes_anterior')">
                                    <span class="flex-1 text-left">Mes anterior</span>
                                    <mat-icon *ngIf="rangoFechaSeleccionado === 'mes_anterior'"
                                        [svgIcon]="'heroicons_solid:check'"></mat-icon>
                                </button>

                                <button mat-button class="h-12 rounded-lg border-2" [ngClass]="{
                                        'border-primary text-primary': rangoFechaSeleccionado === 'fecha_especifica'
                                    }" (click)="seleccionarRangoFecha('fecha_especifica')">
                                    Fecha específica
                                </button>

                                <button mat-button class="h-12 rounded-lg border-2" [ngClass]="{
                                        'border-primary text-primary': rangoFechaSeleccionado === 'periodo'
                                    }" (click)="seleccionarRangoFecha('periodo')">
                                    Periodo
                                </button>
                            </div>
                        </div>

                        <div *ngIf="rangoFechaSeleccionado === 'fecha_especifica'"
                            class="p-4 border-t bg-gray-50 dark:bg-gray-900">
                            <h4 class="text-sm font-medium mb-3">Selecciona una fecha</h4>
                            <mat-form-field class="w-full">
                                <input matInput [matDatepicker]="pickerPcUnica" [formControl]="fechaInicioControl">
                                <mat-datepicker-toggle matIconSuffix [for]="pickerPcUnica"></mat-datepicker-toggle>
                                <mat-datepicker #pickerPcUnica></mat-datepicker>
                            </mat-form-field>
                            <button mat-flat-button color="primary" class="w-full" (click)="aplicarFiltroFechas()">
                                Aplicar
                            </button>
                        </div>

                        <div *ngIf="rangoFechaSeleccionado === 'periodo'"
                            class="p-4 border-t bg-gray-50 dark:bg-gray-900">
                            <h4 class="text-sm font-medium mb-3">Rango personalizado</h4>
                            <mat-form-field class="w-full">
                                <mat-label>Fecha Desde</mat-label>
                                <input matInput [matDatepicker]="pickerPcInicio" [formControl]="fechaInicioControl">
                                <mat-datepicker-toggle matIconSuffix [for]="pickerPcInicio"></mat-datepicker-toggle>
                                <mat-datepicker #pickerPcInicio></mat-datepicker>
                            </mat-form-field>
                            <mat-form-field class="w-full">
                                <mat-label>Fecha Hasta</mat-label>
                                <input matInput [matDatepicker]="pickerPcFin" [formControl]="fechaFinControl">
                                <mat-datepicker-toggle matIconSuffix [for]="pickerPcFin"></mat-datepicker-toggle>
                                <mat-datepicker #pickerPcFin></mat-datepicker>
                            </mat-form-field>
                            <button mat-flat-button color="primary" class="w-full" (click)="aplicarFiltroFechas()">
                                Aplicar rango
                            </button>
                        </div>
                    </div>
                </div>

                <mat-form-field class="fuse-mat-dense fuse-mat-rounded flex-1">
                    <mat-icon matPrefix [svgIcon]="'heroicons_solid:magnifying-glass'"></mat-icon>
                    <input matInput [formControl]="searchControl" placeholder="Buscar...">
                </mat-form-field>
            </div>

            <div class="flex gap-3">
                <mat-form-field class="fuse-mat-dense fuse-mat-rounded flex-1">
                    <mat-icon matPrefix [svgIcon]="'heroicons_solid:building-office'"></mat-icon>
                    <mat-select [formControl]="deptoControl" placeholder="Departamento">
                        <mat-option [value]="''">Todos</mat-option>
                        <mat-option *ngFor="let depto of departamentosUnicos" [value]="depto">{{ depto }}</mat-option>
                    </mat-select>
                </mat-form-field>
            </div>
        </div>

        <div *ngIf="mostrarPanelFechas" class="fixed inset-0 bg-black/30 z-40" (click)="toggleDatePanel()"></div>
    </div>

    <!-- ===== CONTENIDO PRINCIPAL ===== -->
    <div class="flex flex-auto overflow-hidden">
        <div class="flex flex-col flex-auto overflow-y-auto">

            <!-- Empty state -->
            <ng-container *ngIf="!isLoading && datosFiltrados.length === 0">
                <div class="flex flex-col items-center justify-center flex-auto p-8">
                    <div
                        class="flex items-center justify-center w-24 h-24 rounded-full bg-gray-100 dark:bg-gray-800 mb-6">
                        <mat-icon class="icon-size-16 text-hint" [svgIcon]="'heroicons_outline:inbox'"></mat-icon>
                    </div>
                    <div class="text-2xl font-semibold tracking-tight mb-2">Sin datos de producción</div>
                    <div class="text-md text-secondary text-center max-w-md">
                        No se encontraron registros con los filtros seleccionados.
                    </div>
                </div>
            </ng-container>

            <!-- Contenido con datos -->
            <ng-container *ngIf="!isLoading && datosFiltrados.length > 0">

                <!-- Tabla con Tabs -->
                <div class="overflow-x-auto px-1 md:px-8 pb-6">
                    <mat-tab-group animationDuration="300ms" [disableRipple]="true" [(selectedIndex)]="selectedTabIndex"
                        (selectedIndexChange)="onTabChange($event)">

                        <!-- ========== TAB 1: PROCESOS ========== -->
                        <mat-tab>
                            <ng-template mat-tab-label>
                                <mat-icon class="icon-size-5 mr-2"
                                    [svgIcon]="'heroicons_solid:building-office'"></mat-icon>
                                <span class="font-medium">Procesos</span>
                            </ng-template>

                            <ng-template matTabContent>
                                <tabs-procesos-tab></tabs-procesos-tab>
                            </ng-template>
                        </mat-tab>

                        <!-- ========== TAB 2: PRODUCCIÓN DE TEJIDO ========== -->
                        <mat-tab>
                            <ng-template mat-tab-label>
                                <mat-icon class="icon-size-5 mr-2" 
                                [svgIcon]="'heroicons_solid:cog-8-tooth'"></mat-icon>
                                <span class="font-medium">Producción de Tejido</span>
                            </ng-template>

                            <ng-template matTabContent>
                                <tabs-produccion-tejido></tabs-produccion-tejido>
                            </ng-template>
                        </mat-tab>

                        <!-- ========== TAB 3: REVISADO DE TEJIDO ========== -->
                        <mat-tab>
                            <ng-template mat-tab-label>
                                <mat-icon class="icon-size-5 mr-2"
                                    [svgIcon]="'heroicons_solid:clipboard-document-check'"></mat-icon>
                                <span class="font-medium">Revisado de Tejido</span>
                            </ng-template>

                            <ng-template matTabContent>
                                <tabs-tejido-revisado></tabs-tejido-revisado>
                            </ng-template>
                        </mat-tab>

                        <!-- ========== TAB 4: POR REVISAR ========== -->
                        <mat-tab>
                            <ng-template mat-tab-label>
                                <mat-icon class="icon-size-5 mr-2" [svgIcon]="'heroicons_solid:x-circle'"></mat-icon>
                                <span class="font-medium">Por revisar</span>
                            </ng-template>

                            <ng-template matTabContent>
                                <tabs-por-revisar></tabs-por-revisar>
                            </ng-template>
                        </mat-tab>

                        <!-- ========== TAB 5: SALDOS ========== -->
                        <mat-tab>
                            <ng-template mat-tab-label>
                                <mat-icon class="icon-size-5 mr-2"
                                    [svgIcon]="'heroicons_solid:currency-dollar'"></mat-icon>
                                <span class="font-medium">Saldos</span>
                            </ng-template>

                            <ng-template matTabContent>
                                <tabs-saldos></tabs-saldos>
                            </ng-template>
                        </mat-tab>

                        <!-- ========== TAB 6: EMBARQUES ========== -->
                        <mat-tab>
                            <ng-template mat-tab-label>
                                <mat-icon class="icon-size-5 mr-2" [svgIcon]="'heroicons_solid:truck'"></mat-icon>
                                <span class="font-medium">Entregado a Embarques</span>
                            </ng-template>

                            <ng-template matTabContent>
                                <tabs-embarques></tabs-embarques>
                            </ng-template>
                        </mat-tab>

                    </mat-tab-group>
                </div>
            </ng-container>
        </div>
    </div>
</div>