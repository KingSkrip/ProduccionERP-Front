<!-- Tarjetas de resumen - Solo mostrar si hay datos -->
<div class="md:px-8 md:py-4" *ngIf="!loading && datosFiltrados.length > 0">

    <!-- Card móvil - Simple y limpio -->
    <div class="md:hidden">
        <div class="bg-card shadow-sm rounded-xl px-5 py-4 border-l-4 border-green-500">
            <div class="flex items-center justify-between gap-4">
                <!-- Contenido principal -->
                <div class="flex-1 min-w-0">
                    <div class="text-sm font-medium text-secondary mb-2">
                        Cantidad total
                    </div>
                    <div class="flex items-baseline gap-2">
                        <div class="text-3xl font-bold">
                            {{ calcularCantidadTotal() | number:'1.0-0' }}
                        </div>
                        <div class="text-sm text-secondary">
                            kg
                        </div>
                    </div>
                </div>

                <!-- Icono -->
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 rounded-lg bg-green-500/10 flex items-center justify-center">
                        <mat-icon class="text-green-500 icon-size-6" [svgIcon]="'heroicons_solid:clipboard-document-list'">
                        </mat-icon>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cards desktop -->
    <div class="hidden md:grid grid-cols-3 gap-3">
        <div class="bg-card shadow-sm rounded-xl p-4 border-l-4 border-green-500">
            <div class="flex items-center justify-between mb-1">
                <div class="text-base text-secondary">Cantidad total</div>
                <mat-icon class="text-green-500 icon-size-5" [svgIcon]="'heroicons_solid:clipboard-document-list'"></mat-icon>
            </div>
            <div class="text-2xl font-bold">{{ calcularCantidadTotal() | number:'1.0-0' }}
            </div>
            <div class="text-sm text-secondary">Kilogramos</div>
        </div>
    </div>
</div>

<!-- Loading State -->
<div *ngIf="loading" class="flex flex-col items-center justify-center py-16 px-4">
    <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin mb-4"></div>
    <p class="text-secondary">Cargando datos de tejido...</p>
</div>

<!-- Empty State - Cuando no hay resultados con los filtros aplicados -->
<div *ngIf="!loading && datosFiltrados.length === 0 && cargaInicial" class="flex flex-col items-center justify-center py-16 px-4">
    <div class="relative mb-6">
        <div class="w-24 h-24 rounded-2xl bg-sky-500/10 flex items-center justify-center">
            <mat-icon class="icon-size-12 text-sky-500/40" [svgIcon]="'heroicons_outline:clipboard-document-list'"></mat-icon>
        </div>
    </div>
    
    <h3 class="text-xl font-bold mb-2">No hay datos de tejido</h3>
    <p class="text-secondary text-center max-w-md mb-4">
        No se encontraron registros con los filtros seleccionados.
        <br>Intenta ajustar tus criterios de búsqueda o seleccionar otro departamento.
    </p>
    
    <button mat-stroked-button class="rounded-xl" (click)="limpiarFiltrosLocales()">
        <mat-icon class="icon-size-5 mr-2" [svgIcon]="'heroicons_solid:arrow-path'"></mat-icon>
        Limpiar filtros
    </button>
</div>

<!-- Tabla -->
<div class="mt-6 overflow-x-hidden md:overflow-x-auto md:px-8" *ngIf="!loading && datosFiltrados.length > 0">

    <table class="w-full bg-card shadow-sm rounded-2xl overflow-hidden">
        <thead class="bg-gray-50 dark:bg-gray-800">
            <tr>
                <th class="px-3 py-2 md:px-6 md:py-4 text-left text-sm md:text-base font-semibold tracking-wider">
                    Departamento
                </th>
                <th class="px-3 py-2 md:px-6 md:py-4 text-right text-sm md:text-base font-semibold tracking-wider">
                    Piezas
                </th>
                <th class="px-3 py-2 md:px-6 md:py-4 text-right text-sm md:text-base font-semibold tracking-wider">
                    Cantidad (kg)
                </th>
            </tr>
        </thead>

        <tbody class="divide-y">
            <ng-container *ngFor="let grupo of datosAgrupados; let i = index">
                <!-- Fila Departamento -->
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors cursor-pointer"
                    (click)="toggleDepartamento(i)">
                    <td class="px-3 py-2 md:px-6 md:py-4">
                        <div class="flex items-center gap-3">
                            <mat-icon class="icon-size-4 transition-transform"
                                [ngClass]="{'rotate-90': grupo.expandido}"
                                [svgIcon]="'heroicons_solid:chevron-right'"></mat-icon>

                            <mat-icon class="icon-size-5 text-blue-500"
                                [svgIcon]="'heroicons_solid:building-office'"></mat-icon>

                            <div>
                                <div class="font-semibold capitalize">
                                    {{ grupo.departamento | lowercase }}
                                </div>

                                <div class="text-xs text-secondary">{{ grupo.procesos.length }} procesos</div>
                            </div>
                        </div>
                    </td>

                    <td class="px-3 py-2 md:px-6 md:py-4 text-right">
                        <span class="font-bold text-blue-600 text-lg">
                            {{ grupo.piezasTotal | number:'1.0-0' }}
                        </span>
                    </td>

                    <td class="px-3 py-2 md:px-6 md:py-4 text-right">
                        <span class="font-bold text-green-600 dark:text-green-400 text-lg">
                            {{ grupo.cantidadTotal | number:'1.2-2' }}
                        </span>
                    </td>
                </tr>

                <!-- Filas Procesos -->
                <tr *ngFor="let proceso of grupo.procesos" [style.display]="grupo.expandido ? 'table-row' : 'none'"
                    class="bg-gray-50 dark:bg-gray-800/50">
                    <td class="px-6 py-3 pl-20">
                        <div class="flex items-center gap-3">
                            <mat-icon class="icon-size-4 text-gray-400" [svgIcon]="'heroicons_solid:cog-8-tooth'">
                            </mat-icon>

                            <span class="text-sm text-secondary capitalize">
                                {{ proceso.proceso | lowercase }}
                            </span>
                        </div>
                    </td>

                    <!-- PIEZAS del proceso -->
                    <td class="px-6 py-3 text-right">
                        <span class="text-sm font-medium text-blue-600">
                            {{ proceso.piezas | number:'1.0-0' }}
                        </span>
                    </td>

                    <!-- CANTIDAD del proceso -->
                    <td class="px-6 py-3 text-right">
                        <span class="text-sm font-medium text-green-600 dark:text-green-400">
                            {{ proceso.cantidad | number:'1.2-2' }}
                        </span>
                    </td>
                </tr>
            </ng-container>
        </tbody>

        <!-- TOTAL GENERAL -->
        <tfoot class="bg-gray-50 dark:bg-gray-800 font-bold border-t-2">
            <tr>
                <!-- Label ocupa 2 columnas -->
                <td class="px-3 py-2 md:px-6 md:py-4 text-right text-base" colspan="2">
                    Total general:
                </td>

                <!-- Total hasta la derecha (última columna) -->
                <td class="px-3 py-2 md:px-6 md:py-4 text-right">
                    <span class="text-lg text-blue-600 dark:text-blue-400">
                        {{ calcularCantidadTotal() | number:'1.2-2' }}
                    </span>
                </td>
            </tr>
        </tfoot>
    </table>
</div>