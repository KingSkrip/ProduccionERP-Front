<div class="flex min-w-0 flex-auto flex-col">
  <div
    class="bg-card flex flex-0 flex-col border-b px-6 py-6 sm:flex-row sm:items-center sm:justify-between sm:px-10 sm:py-8 dark:bg-transparent"
  >
    <div class="flex flex-col">
      <h2 class="mt-1 text-3xl font-extrabold tracking-tight md:text-4xl">Mis pedidos</h2>
      <p class="text-secondary text-sm font-semibold tracking-widest md:text-base">
        Comercializadora fibrasan
      </p>
    </div>

    <!-- Filtros PC -->
    <div class="mt-5 hidden flex-wrap items-center gap-3 sm:mt-0 sm:flex">
      <!-- Búsqueda -->
      <mat-form-field
        class="fuse-mat-dense fuse-mat-rounded min-w-56"
        [subscriptSizing]="'dynamic'"
      >
        <mat-icon
          class="icon-size-4"
          matPrefix
          svgIcon="heroicons_outline:magnifying-glass"
        ></mat-icon>
        <input
          matInput
          [formControl]="searchControl"
          autocomplete="off"
          placeholder="Pedido, referencia…"
        />
        <button
          *ngIf="searchControl.value"
          matSuffix
          mat-icon-button
          (click)="searchControl.setValue('')"
        >
          <mat-icon class="icon-size-4" svgIcon="heroicons_outline:x-mark"></mat-icon>
        </button>
      </mat-form-field>

      <!-- Botón de filtros avanzados -->
      <div class="relative">
        <button
          mat-stroked-button
          class="h-10 rounded-3xl border-2 bg-primary-500 px-5 transition-all hover:border-primary/40"
          [class.border-primary]="filtrosActivosCount() > 0"
          (click)="togglePanelFiltrosPc()"
        >
          <span class="flex w-full items-center gap-2">
            <mat-icon
              class="text-white icon-size-5"
              [class.text-primary]="filtrosActivosCount() > 0"
              svgIcon="heroicons_outline:adjustments-horizontal"
            ></mat-icon>
            <span class="text-sm font-medium text-white">Filtros</span>
            <span
              *ngIf="filtrosActivosCount() > 0"
              class="ml-1 rounded-full bg-primary px-2 py-0.5 text-xs font-semibold leading-none text-white"
            >
              {{ filtrosActivosCount() }}
            </span>
            <mat-icon
              class="ml-auto text-white transition-transform icon-size-4"
              [class.rotate-180]="mostrarPanelFiltrosPc"
              svgIcon="heroicons_outline:chevron-down"
            ></mat-icon>
          </span>
        </button>

        <!-- Panel desplegable PC -->
        <div
          *ngIf="mostrarPanelFiltrosPc"
          class="absolute right-0 top-full z-50 mt-2 flex max-h-[calc(70vh-70px)] min-h-0 w-[480px] flex-col rounded-2xl border-2 bg-white shadow-2xl dark:bg-gray-800"
          [@slideDown]
        >
          <!-- Header -->
          <div class="flex-shrink-0 border-b bg-gradient-to-r from-primary/5 to-transparent p-4">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-primary/10">
                  <mat-icon
                    class="text-primary-500 icon-size-5"
                    svgIcon="heroicons_outline:funnel"
                  ></mat-icon>
                </div>
                <h3 class="text-lg font-semibold">Filtros avanzados</h3>
              </div>
              <button
                mat-icon-button
                (click)="togglePanelFiltrosPc()"
                class="hover:bg-gray-100 dark:hover:bg-gray-700"
              >
                <mat-icon class="icon-size-5" svgIcon="heroicons_outline:x-mark"></mat-icon>
              </button>
            </div>
          </div>

          <!-- Contenido scrolleable -->
          <div class="min-h-0 flex-1 space-y-5 overflow-y-auto p-5">
            <!-- SECCIÓN: ESTADO -->
            <div>
              <div class="mb-3 flex items-center gap-2">
                <mat-icon
                  class="text-primary icon-size-5"
                  svgIcon="heroicons_outline:tag"
                ></mat-icon>
                <h4 class="font-semibold">Estado</h4>
              </div>
              <mat-form-field class="w-full" appearance="outline">
                <mat-select [formControl]="estadoControl">
                  <mat-option *ngFor="let op of opcionesEstado" [value]="op.value">{{
                    op.label
                  }}</mat-option>
                </mat-select>
              </mat-form-field>
            </div>

            <!-- SECCIÓN: CONDICIÓN DE PAGO -->
            <div class="border-t pt-3">
              <div class="mb-3 flex items-center gap-2">
                <mat-icon
                  class="text-primary icon-size-5"
                  svgIcon="heroicons_outline:credit-card"
                ></mat-icon>
                <h4 class="font-semibold">Condición de pago</h4>
              </div>
              <mat-form-field class="w-full" appearance="outline">
                <mat-select [formControl]="condicionControl">
                  <mat-option *ngFor="let op of opcionesCondicion" [value]="op.value">{{
                    op.label
                  }}</mat-option>
                </mat-select>
              </mat-form-field>
            </div>
          </div>

          <!-- Footer -->
          <div class="flex-shrink-0 border-t bg-gray-50 p-4 dark:bg-gray-900/50">
            <div class="flex gap-3">
              <button
                mat-button
                class="h-11 flex-1 rounded-xl text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20"
                (click)="limpiarFiltros()"
              >
                <mat-icon class="mr-2 icon-size-5" svgIcon="heroicons_outline:x-circle"></mat-icon>
                Limpiar
              </button>
              <button
                mat-flat-button
                color="primary"
                class="h-11 flex-1 rounded-xl shadow-lg"
                (click)="aplicarFiltrosPc()"
              >
                <mat-icon class="mr-2 icon-size-5" svgIcon="heroicons_outline:check"></mat-icon>
                Aplicar filtros
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Indicador de filtros activos -->
      <div *ngIf="filtrosActivosCount() > 0" class="flex items-center gap-2 text-sm">
        <mat-icon
          class="text-base icon-size-4 dark:text-blue-600"
          svgIcon="heroicons_outline:funnel"
        ></mat-icon>
        <span class="text-base text-gray-600 dark:text-white">
          <span class="text-base font-semibold dark:text-blue-600">{{
            filtrosActivosCount()
          }}</span>
          filtro(s) activo(s)
        </span>
        <button
          mat-button
          class="ml-2 h-7 rounded-lg bg-red-500/40 text-base"
          (click)="limpiarFiltros()"
        >
          Limpiar todos
        </button>
      </div>

      <button mat-icon-button matTooltip="Recargar pedidos" (click)="cargarPedidos()">
        <mat-icon class="icon-size-5" svgIcon="heroicons_outline:arrow-path"></mat-icon>
      </button>
    </div>
  </div>

  <!-- ===== BARRA MÓVIL STICKY ===== -->
  <div class="sticky top-0 z-30 bg-white sm:hidden dark:bg-gray-900">
    <div class="flex items-center gap-2 px-3 py-2">
      <mat-form-field
        class="fuse-mat-dense flex-1"
        appearance="outline"
        [subscriptSizing]="'dynamic'"
      >
        <mat-icon
          matPrefix
          class="text-gray-400 icon-size-5"
          svgIcon="heroicons_outline:magnifying-glass"
        ></mat-icon>
        <input
          matInput
          [formControl]="searchControl"
          [autocomplete]="'off'"
          placeholder="Buscar pedido…"
        />
      </mat-form-field>
      <button
        mat-mini-fab
        color="primary"
        class="relative shadow-md"
        (click)="togglePanelFiltros()"
        [matBadge]="filtrosActivosCount()"
        matBadgeSize="small"
        matBadgeColor="accent"
        [matBadgeHidden]="filtrosActivosCount() === 0"
      >
        <mat-icon svgIcon="heroicons_outline:adjustments-horizontal"></mat-icon>
      </button>
    </div>
  </div>

  <!-- Overlay oscuro móvil -->
  <div
    *ngIf="mostrarPanelFiltros"
    class="fixed inset-0 z-40 bg-black/60 backdrop-blur-sm sm:hidden"
    (click)="togglePanelFiltros()"
    [@fadeIn]
  ></div>

  <!-- Panel de filtros móvil - desde abajo -->
  <div
    *ngIf="mostrarPanelFiltros"
    class="bg-card fixed bottom-0 left-0 right-0 z-50 flex max-h-[85vh] flex-col rounded-t-3xl shadow-2xl sm:hidden"
  >
    <!-- Header -->
    <div class="flex items-center justify-between border-b p-4">
      <h2 class="text-lg font-semibold">Filtros avanzados</h2>
      <button mat-icon-button (click)="togglePanelFiltros()">
        <mat-icon svgIcon="heroicons_outline:x-mark"></mat-icon>
      </button>
    </div>

    <!-- Contenido scrolleable -->
    <div class="flex-1 space-y-5 overflow-y-auto p-4">
      <!-- ESTADO -->
      <div>
        <div class="mb-3 flex items-center gap-2">
          <mat-icon class="text-primary icon-size-5" svgIcon="heroicons_outline:tag"></mat-icon>
          <h3 class="text-sm font-medium">Estado</h3>
        </div>
        <mat-form-field class="w-full" appearance="outline">
          <mat-select [formControl]="estadoControl">
            <mat-option *ngFor="let op of opcionesEstado" [value]="op.value">{{
              op.label
            }}</mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <!-- CONDICIÓN DE PAGO -->
      <div>
        <div class="mb-3 flex items-center gap-2">
          <mat-icon
            class="text-primary icon-size-5"
            svgIcon="heroicons_outline:credit-card"
          ></mat-icon>
          <h3 class="text-sm font-medium">Condición de pago</h3>
        </div>
        <mat-form-field class="w-full" appearance="outline">
          <mat-select [formControl]="condicionControl">
            <mat-option *ngFor="let op of opcionesCondicion" [value]="op.value">{{
              op.label
            }}</mat-option>
          </mat-select>
        </mat-form-field>
      </div>
    </div>

    <!-- Footer -->
    <div class="bg-card border-t p-4">
      <div class="flex gap-2">
        <button mat-stroked-button class="h-11 flex-1 rounded-full" (click)="limpiarFiltros()">
          Limpiar
        </button>
        <button
          mat-flat-button
          color="primary"
          class="h-11 flex-1 rounded-full"
          (click)="aplicarFiltrosMovil()"
        >
          Aplicar
        </button>
      </div>
    </div>
  </div>

  <!-- Overlay para cerrar panel PC -->
  <div
    *ngIf="mostrarPanelFiltrosPc"
    class="fixed inset-0 z-40"
    (click)="togglePanelFiltrosPc()"
  ></div>


  <div class="flex flex-auto overflow-hidden">
    <div class="flex flex-auto flex-col overflow-y-auto px-4 pb-20 sm:px-8">
      <!-- Loading -->
      <ng-container *ngIf="cargando()">
        <div class="flex flex-auto flex-col items-center justify-center py-20">
          <div class="relative h-16 w-16">
            <div
              class="absolute inset-0 animate-spin rounded-full border-4 border-gray-200 border-t-primary dark:border-gray-700 dark:border-t-primary-400"
            ></div>
          </div>
          <p class="mt-6 text-sm text-gray-500 dark:text-white">Cargando mis pedidos...</p>
        </div>
      </ng-container>

      <!-- Datos vacíos -->
      <div
        *ngIf="!cargando() && pedidosFiltrados().length === 0"
        class="flex flex-col items-center justify-center py-20 text-center"
      >
        <mat-icon
          svgIcon="heroicons_outline:inbox"
          class="mb-3 text-gray-300 icon-size-16 dark:text-gray-600"
        ></mat-icon>
        <p class="text-default text-base font-bold">No se encontraron pedidos</p>
        <p class="text-secondary mt-1 text-sm">Intenta cambiar los filtros de búsqueda</p>
        <button mat-stroked-button class="mt-4" (click)="limpiarFiltros()">
          <mat-icon svgIcon="heroicons_outline:arrow-path" class="mr-1 icon-size-4"></mat-icon>
          Limpiar filtros
        </button>
      </div>

      <!-- Lista de pedidos -->
      <div *ngIf="!cargando()" class="mt-4 flex flex-col gap-3">
        <div
          *ngFor="let pedido of pedidosFiltrados(); trackBy: trackByCve"
          class="bg-card overflow-hidden rounded-2xl border shadow-sm transition-all duration-200 hover:shadow-md dark:border-gray-700"
          [class.border-primary]="estaExpandido(pedido.cve_ped)"
          [class.ring-1]="estaExpandido(pedido.cve_ped)"
        >
          <!-- Cabecera del pedido -->
          <div
            class="flex cursor-pointer select-none items-center gap-3 px-4 py-4 hover:bg-hover sm:gap-5 sm:px-5"
            (click)="toggleExpand(pedido.cve_ped)"
          >
            <div class="flex min-w-0 flex-1 flex-col gap-0.5">
              <span class="text-default text-sm font-bold">Pedido: {{ pedido.cve_ped }}</span>
              <span *ngIf="pedido.referencia" class="text-secondary truncate text-xs"
                >Referencia: {{ pedido.referencia }}</span
              >
              <span *ngIf="!pedido.referencia" class="text-hint text-xs italic"
                >Sin referencia</span
              >
            </div>

            <div class="text-secondary hidden items-center gap-1 text-xs sm:flex">
              <mat-icon class="icon-size-4" svgIcon="heroicons_outline:user"></mat-icon>
              <span>{{ pedido.agente || 'Sin agente' }}</span>
            </div>

            <div class="text-secondary hidden items-center gap-1 text-xs sm:flex">
              <mat-icon
                class="icon-size-4"
                [svgIcon]="
                  pedido.credito === 'SI'
                    ? 'heroicons_outline:credit-card'
                    : 'heroicons_outline:clock'
                "
              ></mat-icon>
              <span>{{ pedido.condicion || 'Sin definir' }}</span>
              <span *ngIf="pedido.dias_credito > 0" class="text-hint"
                >({{ pedido.dias_credito }}d)</span
              >
            </div>

            <div
              *ngIf="pedido.fecha_elab"
              class="text-secondary hidden items-center gap-1 text-xs md:flex"
            >
              <mat-icon class="icon-size-4" svgIcon="heroicons_outline:calendar"></mat-icon>
              <span>{{ pedido.fecha_elab }}</span>
            </div>

            <div class="text-secondary hidden items-center gap-1 text-xs lg:flex">
              <mat-icon class="icon-size-4" svgIcon="heroicons_outline:truck"></mat-icon>
              <span *ngIf="pedido.fecha_entrega">{{ pedido.fecha_entrega }}</span>
              <span *ngIf="!pedido.fecha_entrega" class="text-hint">—</span>
            </div>

            <div
              *ngIf="pedido.articulos?.length > 0"
              class="text-secondary hidden items-center gap-1 text-xs xl:flex"
            >
              <mat-icon class="icon-size-4" svgIcon="heroicons_outline:squares-2x2"></mat-icon>
              <span>{{ pedido.articulos.length }} art.</span>
            </div>

            <button
              mat-icon-button
              class="text-secondary flex-shrink-0"
              matTooltip="Descargar PDF"
              [disabled]="descargando() === pedido.cve_ped"
              (click)="$event.stopPropagation(); descargarPDF(pedido.cve_ped)"
            >
              <mat-icon
                class="icon-size-5"
                [svgIcon]="
                  descargando() === pedido.cve_ped
                    ? 'heroicons_outline:arrow-path'
                    : 'heroicons_outline:arrow-down-tray'
                "
              ></mat-icon>
            </button>

            <button
              mat-icon-button
              class="text-secondary flex-shrink-0"
              [matTooltip]="estaExpandido(pedido.cve_ped) ? 'Ocultar detalle' : 'Ver detalle'"
              (click)="$event.stopPropagation(); toggleExpand(pedido.cve_ped)"
            >
              <mat-icon
                class="transition-transform duration-200 icon-size-5"
                [class.rotate-180]="estaExpandido(pedido.cve_ped)"
                svgIcon="heroicons_outline:chevron-down"
              ></mat-icon>
            </button>
          </div>

          <!-- Info extra móvil -->
          <div
            class="text-secondary flex gap-4 border-t px-5 py-2 text-xs sm:hidden dark:border-gray-700"
          >
            <span class="flex items-center gap-1">
              <mat-icon class="icon-size-3" svgIcon="heroicons_outline:credit-card"></mat-icon>
              {{ pedido.condicion || 'Sin definir' }}
            </span>
            <span *ngIf="pedido.fecha_elab" class="flex items-center gap-1">
              <mat-icon class="icon-size-3" svgIcon="heroicons_outline:calendar"></mat-icon>
              {{ pedido.fecha_elab }}
            </span>
          </div>

          <!-- Panel colapsable -->
          <div
            *ngIf="estaExpandido(pedido.cve_ped)"
            class="border-t px-4 pb-5 pt-4 sm:px-5 dark:border-gray-700"
          >
            <div
              class="mb-5 flex flex-wrap items-center gap-4 rounded-2xl bg-gray-50 px-4 py-3 dark:bg-gray-800/40"
            >
              <div *ngIf="pedido.agente" class="flex items-center gap-1.5">
                <mat-icon
                  class="text-gray-400 icon-size-4"
                  svgIcon="heroicons_outline:user"
                ></mat-icon>
                <span class="text-default text-xs font-semibold">{{ pedido.agente }}</span>
              </div>
              <div *ngIf="pedido.fecha_elab" class="flex items-center gap-1.5">
                <mat-icon
                  class="text-gray-400 icon-size-4"
                  svgIcon="heroicons_outline:calendar"
                ></mat-icon>
                <span class="text-secondary text-xs">Elab.</span>
                <span class="text-default text-xs font-semibold">{{ pedido.fecha_elab }}</span>
              </div>
              <div *ngIf="pedido.fecha_entrega" class="flex items-center gap-1.5">
                <mat-icon
                  class="text-gray-400 icon-size-4"
                  svgIcon="heroicons_outline:truck"
                ></mat-icon>
                <span class="text-secondary text-xs">Entrega</span>
                <span class="text-default text-xs font-semibold">{{ pedido.fecha_entrega }}</span>
              </div>
              <div *ngIf="pedido.fecha_pago" class="flex items-center gap-1.5">
                <mat-icon
                  class="text-gray-400 icon-size-4"
                  svgIcon="heroicons_outline:banknotes"
                ></mat-icon>
                <span class="text-secondary text-xs">Pago</span>
                <span class="text-default text-xs font-semibold">{{ pedido.fecha_pago }}</span>
              </div>
            </div>

            <div *ngIf="pedido.articulos?.length > 0" class="mb-4">
              <p class="text-secondary mb-2 text-xs font-bold uppercase tracking-wider">
                Artículos
              </p>
              <div class="flex flex-col gap-1.5">
                <div
                  *ngFor="let a of pedido.articulos"
                  class="flex items-center justify-between border-l-4 border-primary bg-primary/5 py-2 pl-3 pr-4 dark:bg-primary/10"
                >
                  <span class="text-default text-sm font-medium">{{ a.ARTICULO }}</span>
                  <span class="text-sm font-extrabold tabular-nums text-primary"
                    >{{ a.CANTIDAD }} kg</span
                  >
                </div>
              </div>
            </div>

            <div *ngIf="pedido.cardigans?.length > 0">
              <p class="text-secondary mb-2 text-xs font-bold uppercase tracking-wider">
                Cardigans
              </p>
              <div class="flex flex-col gap-1.5">
                <div
                  *ngFor="let c of pedido.cardigans"
                  class="flex items-center justify-between border-l-4 border-purple-400 bg-purple-50 py-2 pl-3 pr-4 dark:bg-purple-900/20"
                >
                  <span class="text-default text-sm font-medium">{{ c.DESCRIPCION }}</span>
                  <span
                    class="text-sm font-extrabold tabular-nums text-purple-600 dark:text-purple-400"
                    >{{ c.CANTIDAD }} kg</span
                  >
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
