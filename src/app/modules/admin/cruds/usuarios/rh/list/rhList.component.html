<div class="bg-card flex min-w-0 flex-auto flex-col dark:bg-transparent w-full h-full">

    <!-- Header -->
    <div
        class="relative flex flex-0 flex-col border-b px-6 py-8 sm:flex-row sm:items-center sm:justify-between md:px-8">
        @if (isLoading) {
        <div class="absolute inset-x-0 bottom-0">
            <mat-progress-bar [mode]="'indeterminate'"></mat-progress-bar>
        </div>
        }

        <div class="text-4xl font-extrabold tracking-tight">
            Gestionar super usuarios
        </div>

        <div class="mt-6 flex shrink-0 items-center sm:ml-4 sm:mt-0">
            <mat-form-field class="fuse-mat-dense fuse-mat-rounded min-w-64" [subscriptSizing]="'dynamic'">
                <mat-icon class="icon-size-5" matPrefix [svgIcon]="'heroicons_solid:magnifying-glass'"></mat-icon>
                <input matInput [formControl]="searchInputControl" [autocomplete]="'off'"
                    placeholder="Buscar super usuarios" />
            </mat-form-field>

            <button class="ml-4" mat-flat-button [color]="'primary'" (click)="AddModal()">
                <mat-icon [svgIcon]="'heroicons_outline:plus'"></mat-icon>
                <span class="ml-2 mr-1">Agregar</span>
            </button>
        </div>
    </div>

    <!-- Main -->
    <div class="flex flex-auto overflow-hidden">
        <div class="flex flex-auto flex-col overflow-hidden sm:mb-18 sm:overflow-y-auto">

            @if (usuarios$ | async; as usuarios) {
            @if (usuarios.length > 0) {
            <div class="grid">

                <!-- Cabecera de tabla -->
                <div class="grid grid-cols-[48px_1fr_auto] sm:grid-cols-[48px_64px_minmax(180px,1fr)_minmax(220px,1fr)_96px]
                                    text-secondary sticky top-0 z-10 gap-6 bg-gray-50 px-6 py-4 text-md font-semibold shadow
                                    dark:bg-black dark:bg-opacity-5 md:px-8" matSort matSortDisableClear>

                    <div class="hidden sm:block text-center w-12" [mat-sort-header]="'id'">#</div>
                    <div class="flex items-center justify-center w-12">Foto</div>
                    <div class="pl-2">Nombre</div>
                    <div class="hidden sm:block pl-2" [mat-sort-header]="'email'">Correo</div>
                    <div class="text-center w-24">Detalles</div>
                </div>

                <!-- Filas -->
                @for (usuario of paginatedUsuarios; track trackByFn($index, usuario); let idx = $index) {
                <div class="grid grid-cols-[48px_1fr_auto] sm:grid-cols-[48px_64px_minmax(180px,1fr)_minmax(220px,1fr)_96px]
                                        items-center gap-6 border-b px-4 py-3 md:px-8">

                    <div class="hidden sm:block text-center font-semibold w-12">{{ idx + 1 }}</div>

                    <div class="flex items-center justify-center w-12">
                        <div class="relative flex h-10 w-10 overflow-hidden rounded-full border bg-gray-100">
                            <img [src]="getPhotoUrl(usuario.photo)" class="h-full w-full object-cover" />
                        </div>
                    </div>

                    <div class="truncate pl-2">{{ usuario.name }}</div>
                    <div class="hidden sm:block truncate pl-2">{{ usuario.email }}</div>

                    <div class="flex justify-center w-24">
                        <button mat-stroked-button class="h-7 min-h-7 min-w-10 px-2 leading-6"
                            (click)="toggleDetails(usuario)">
                            <mat-icon class="icon-size-5"
                                [svgIcon]="selectedUsuario?.id === usuario.id ? 'heroicons_solid:chevron-up' : 'heroicons_solid:chevron-down'">
                            </mat-icon>
                        </button>
                    </div>
                </div>

                <!-- Detalles expandibles -->
                @if (selectedUsuario?.id === usuario.id) {
                <ng-container *ngTemplateOutlet="rowDetailsTemplate; context: {$implicit: usuario}"></ng-container>
                }
                }
            </div>

            <!-- Paginador personalizado con estilo oscuro minimalista -->
            <div class="flex justify-center space-x-2 p-4  dark:bg-gray-900 dark:text-white">

                <!-- Botón anterior -->
                <button class="px-3 py-1 rounded hover:bg-gray-700 transition-all duration-200" (click)="prevPage()"
                    [disabled]="currentPage === 0">
                    <mat-icon>chevron_left</mat-icon>
                </button>

                <!-- Números -->
                <div class="flex items-center space-x-2">
                    <button *ngFor="let p of totalPagesArray" (click)="goToPage(p)"
                        class="px-3 py-1 rounded transition-all duration-200" [ngClass]="{
        'bg-primary-600 text-white': p === currentPage,
        'hover:bg-gray-700': p !== currentPage
      }">
                        {{ p + 1 }}
                    </button>
                </div>

                <!-- Botón siguiente -->
                <button class="px-3 py-1 rounded hover:bg-gray-700 transition-all duration-200" (click)="nextPage()"
                    [disabled]="currentPage >= totalPages - 1">
                    <mat-icon>chevron_right</mat-icon>
                </button>
            </div>




            } @else {
            <div class="border-t p-8 text-center text-4xl font-semibold tracking-tight sm:p-16">
                ¡No hay usuarios de RH registrados!
            </div>
            }
            }
        </div>
    </div>
</div>

<!-- Plantilla de detalles mejorada -->
<ng-template #rowDetailsTemplate let-usuario>
    <div class="overflow-hidden shadow-lg">
        <form class="w-full" [formGroup]="selectedUsuarioForm">
            <div class="p-4 sm:p-6 lg:p-8">
                <div class="grid grid-cols-1 gap-6 lg:grid-cols-12 lg:gap-8">

                    <!-- Foto de perfil -->
                    <div class="flex justify-center lg:col-span-3">
                        <div class="flex flex-col items-center">
                            <div
                                class="relative flex h-40 w-40 flex-shrink-0 items-center justify-center overflow-hidden rounded-full border-4 border-primary-200 bg-gray-50 shadow-lg transition-all hover:border-primary-400">
                                <img [src]="selectedPhotoUrl" class="h-full w-full object-cover" alt="Foto de perfil" />
                            </div>
                            <p class="mt-4 text-center text-sm font-medium text-gray-600">Foto de perfil</p>
                        </div>
                    </div>

                    <!-- Campos del formulario -->
                    <div class="lg:col-span-9">
                        <!-- Sección: Información Personal -->
                        <div class="mb-4">
                            <h3 class="mb-3 text-base font-semibold dark:text-white text-black border-b pb-2">
                                Información Personal
                            </h3>
                            <div class="grid grid-cols-1 gap-3 md:grid-cols-2">
                                <mat-form-field class="w-full" appearance="outline">
                                    <mat-label>Nombre completo</mat-label>
                                    <input matInput formControlName="name" placeholder="Ingresa el nombre completo" />
                                    <mat-icon matPrefix class="text-gray-400">person</mat-icon>
                                </mat-form-field>

                                <mat-form-field class="w-full" appearance="outline">
                                    <mat-label>Correo electrónico</mat-label>
                                    <input matInput type="email" formControlName="email"
                                        placeholder="correo@ejemplo.com" />
                                    <mat-icon matPrefix class="text-gray-400">email</mat-icon>
                                </mat-form-field>

                                <mat-form-field class="w-full md:col-span-2" appearance="outline">
                                    <mat-label>Departamento</mat-label>
                                    <input matInput formControlName="departamento" placeholder="Ej. Recursos Humanos" />
                                    <mat-icon matPrefix class="text-gray-400">business</mat-icon>
                                </mat-form-field>
                            </div>
                        </div>

                        <!-- Sección: Credenciales de Acceso -->
                        <div>
                            <h3 class="mb-3 text-base font-semibold dark:text-white text-black border-b pb-2">
                                Credenciales de Acceso
                            </h3>
                            <div class="grid grid-cols-1 gap-3 md:grid-cols-2">
                                <mat-form-field class="w-full md:col-span-2" appearance="outline">
                                    <mat-label>Nombre de usuario</mat-label>
                                    <input matInput formControlName="usuario" placeholder="usuario123"
                                        autocomplete="off" />
                                    <mat-icon matPrefix class="text-gray-400">account_circle</mat-icon>
                                </mat-form-field>

                                <mat-form-field class="w-full" appearance="outline">
                                    <mat-label>Nueva contraseña</mat-label>
                                    <input matInput [type]="showPassword ? 'text' : 'password'"
                                        formControlName="password" placeholder="Mínimo 8 caracteres"
                                        autocomplete="new-password" (paste)="blockPaste($event)" />
                                    <mat-icon matPrefix class="text-gray-400">lock</mat-icon>
                                    <button mat-icon-button matSuffix type="button" (click)="togglePasswordVisibility()"
                                        [attr.aria-label]="'Mostrar contraseña'">
                                        <mat-icon>{{ showPassword ? 'visibility_off' : 'visibility' }}</mat-icon>
                                    </button>
                                    <mat-hint>Dejar vacío para mantener la contraseña actual</mat-hint>
                                </mat-form-field>

                                <mat-form-field class="w-full" appearance="outline">
                                    <mat-label>Confirmar contraseña</mat-label>
                                    <input matInput [type]="showPasswordConfirmation ? 'text' : 'password'"
                                        formControlName="password_confirmation" placeholder="Repite la contraseña"
                                        autocomplete="new-password" (paste)="blockPaste($event)" />
                                    <mat-icon matPrefix class="text-gray-400">lock_outline</mat-icon>
                                    <button mat-icon-button matSuffix type="button"
                                        (click)="togglePasswordConfirmationVisibility()"
                                        [attr.aria-label]="'Mostrar confirmación'">
                                        <mat-icon>{{ showPasswordConfirmation ? 'visibility_off' : 'visibility' }}
                                        </mat-icon>
                                    </button>
                                    <mat-error *ngIf="passwordsDontMatch()">
                                        Las contraseñas no coinciden
                                    </mat-error>
                                </mat-form-field>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Botones de acción -->
            <div
                class="flex flex-col gap-3 border-t px-4 py-4 sm:flex-row sm:items-center sm:justify-between sm:px-6 lg:px-8">
                <button class="order-2 sm:order-1" mat-stroked-button color="warn" type="button"
                    (click)="deleteSelectedUsuario()">
                    <mat-icon class="mr-2">delete</mat-icon>
                    Eliminar usuario
                </button>

                <div class="order-1 flex flex-col items-stretch gap-3 sm:order-2 sm:flex-row sm:items-center">
                    @if (flashMessage) {
                    <div class="flex items-center justify-center rounded-lg px-4 py-2"
                        [ngClass]="flashMessage === 'success' ? 'bg-green-50' : 'bg-red-50'">
                        @if (flashMessage === 'success') {
                        <mat-icon class="text-green-600 mr-2" [svgIcon]="'heroicons_outline:check'"></mat-icon>
                        <span class="text-sm font-medium text-green-800">¡Usuario actualizado!</span>
                        }
                        @if (flashMessage === 'error') {
                        <mat-icon class="text-red-600 mr-2" [svgIcon]="'heroicons_outline:x-mark'"></mat-icon>
                        <span class="text-sm font-medium text-red-800">Error al actualizar</span>
                        }
                    </div>
                    }
                    <button mat-flat-button color="primary" type="button" (click)="updateSelectedUsuario()"
                        class="w-full sm:w-auto">
                        <mat-icon class="mr-2">save</mat-icon>
                        Guardar cambios
                    </button>
                </div>
            </div>
        </form>
    </div>
</ng-template>