<div class="bg-card flex min-w-0 flex-auto flex-col dark:bg-transparent sm:absolute sm:inset-0 sm:overflow-hidden">

    <!-- Header -->
    <div
        class="relative flex flex-0 flex-col border-b px-6 py-8 sm:flex-row sm:items-center sm:justify-between md:px-8">

        <!-- Loader -->
        @if (isLoading) {
        <div class="absolute inset-x-0 bottom-0">
            <mat-progress-bar [mode]="'indeterminate'"></mat-progress-bar>
        </div>
        }
        <!-- Title -->
        <div class="text-4xl font-extrabold tracking-tight">
            Gestionar super usuarios
        </div>
        <!-- Actions -->
        <div class="mt-6 flex shrink-0 items-center sm:ml-4 sm:mt-0">
            <!-- Search -->
            <mat-form-field class="fuse-mat-dense fuse-mat-rounded min-w-64" [subscriptSizing]="'dynamic'">
                <mat-icon class="icon-size-5" matPrefix [svgIcon]="'heroicons_solid:magnifying-glass'"></mat-icon>
                <input matInput [formControl]="searchInputControl" [autocomplete]="'off'"
                    [placeholder]="'Buscar usuarios'" />
            </mat-form-field>

            <!-- Add usuario button -->
            <button class="ml-4" mat-flat-button [color]="'primary'" (click)="AddModal()">
                <mat-icon [svgIcon]="'heroicons_outline:plus'"></mat-icon>
                <span class="ml-2 mr-1">Agregar</span>
            </button>
        </div>
    </div>

    <!-- Main -->
    <div class="flex flex-auto overflow-hidden">
        <!-- Admin list -->
        <div class="flex flex-auto flex-col overflow-hidden sm:mb-18 sm:overflow-y-auto">
            <!-- En la sección de lista -->
            @if (usuarios$ | async; as usuarios) {
            @if (usuarios.length > 0) {
            <div class="grid">
                <!-- Header -->
                <div class="
    grid
    grid-cols-[48px_1fr_auto]
sm:grid-cols-[48px_64px_minmax(180px,1fr)_minmax(220px,1fr)_96px]
    text-secondary sticky top-0 z-10 
    gap-6 bg-gray-50 px-6 py-4 text-md font-semibold shadow 
    dark:bg-black dark:bg-opacity-5 md:px-8" matSort matSortDisableClear>

                    <!-- ID (solo desktop) -->
                    <div class="hidden sm:block text-center w-12" [mat-sort-header]="'id'">
                        #
                    </div>

                    <!-- FOTO (AHORA SÍ visible en móvil) -->
                    <div class="flex items-center justify-center w-12">
                        Foto
                    </div>

                    <!-- Nombre -->
                    <div class="pl-2">
                        Nombre
                    </div>

                    <!-- Email (solo desktop) -->
                    <div class="hidden sm:block pl-2" [mat-sort-header]="'email'">
                        Correo
                    </div>

                    <!-- Detalles -->
                    <div class="text-center w-24">
                        Detalles
                    </div>

                </div>



                <!-- Rows -->
                @for (
                usuario of usuarios;
                track trackByFn($index, usuario);
                let idx = $index
                ) {
                <div class=" grid grid-cols-[48px_1fr_auto] sm:grid-cols-[48px_64px_minmax(180px,1fr)_minmax(220px,1fr)_96px] items-center gap-6 border-b px-4 py-3 md:px-8">



                    <!-- ID -->
                    <div class="hidden sm:block text-center font-semibold w-12">
                        {{ idx + 1 }}
                    </div>

                    <!-- FOTO -->
                    <div class="flex items-center justify-center w-12">
                        <div class="relative flex h-10 w-10 overflow-hidden rounded-full border bg-gray-100">
                            <img [src]="getPhotoUrl(usuario.photo)" class="h-full w-full object-cover" />
                        </div>
                    </div>


                    <!-- Nombre (siempre visible) -->
                    <div class="truncate pl-2">
                        {{ usuario.name }}
                    </div>

                    <!-- Email (solo escritorio) -->
                    <div class="hidden sm:block truncate pl-2">
                        {{ usuario.email }}
                    </div>

                    <!-- Botón Detalles -->
                    <div class="flex justify-center w-24">
                        <button mat-stroked-button class="h-7 min-h-7 min-w-10 px-2 leading-6"
                            (click)="toggleDetails(usuario)">
                            <mat-icon class="icon-size-5" [svgIcon]="selectedUsuario?.id === usuario.id ? 
                'heroicons_solid:chevron-up' : 
                'heroicons_solid:chevron-down'">
                            </mat-icon>
                        </button>
                    </div>
                </div>

                <!-- Detalles expandibles -->
                <div class="grid">
                    @if (selectedUsuario?.id === usuario.id) {
                    <ng-container *ngTemplateOutlet="
                                            rowDetailsTemplate;
                                            context: { $implicit: usuario }
                                        ">
                    </ng-container>
                    }
                </div>
                }
            </div>
            } @else {
            <div class="border-t p-8 text-center text-4xl font-semibold tracking-tight sm:p-16">
                ¡No hay usuarios!
            </div>
            }
            }
            <ng-template #rowDetailsTemplate let-usuario>
                <div class="overflow-hidden shadow-lg">
                    <div *ngIf="selectedUsuarioForm">
                        <!-- Selected usuario form -->
                        <form class="w-full" [formGroup]="selectedUsuarioForm">
                            <div class="p-4 sm:p-6 lg:p-8">
                                <!-- Layout responsive: columna en mobile, dos columnas en desktop -->
                                <div class="grid grid-cols-1 gap-6 lg:grid-cols-12 lg:gap-8">

                                    <!-- Avatar Section - Centrado en mobile, lado izquierdo en desktop -->
                                    <div class="flex justify-center lg:col-span-3 lg:justify-start">
                                        <div class="flex flex-col items-center">
                                            <div
                                                class="relative flex h-32 w-32 flex-shrink-0 items-center justify-center overflow-hidden rounded-full border-4 border-gray-200 bg-gray-100 shadow-md">
                                                <img [src]="selectedPhotoUrl" class="h-full w-full object-cover"
                                                    alt="Usuario" />
                                            </div>
                                            <p class="mt-3 text-center text-sm text-gray-500">
                                                Foto de perfil
                                            </p>
                                        </div>
                                    </div>

                                    <!-- Form Fields - Ocupa todo el ancho en mobile, lado derecho en desktop -->
                                    <div class="lg:col-span-9">
                                        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">

                                            <!-- Name - Ocupa 2 columnas en desktop -->
                                            <div class="sm:col-span-2">
                                                <mat-form-field class="w-full">
                                                    <mat-label>Nombre</mat-label>
                                                    <input matInput [formControlName]="'name'"
                                                        placeholder="Nombre completo" />
                                                </mat-form-field>
                                            </div>

                                            <!-- Email - Ocupa 2 columnas en desktop -->
                                            <div class="sm:col-span-2">
                                                <mat-form-field class="w-full">
                                                    <mat-label>Correo electrónico</mat-label>
                                                    <input matInput type="email" [formControlName]="'email'"
                                                        placeholder="correo@ejemplo.com" />
                                                </mat-form-field>
                                            </div>

                                            <!-- Departamento - 1 columna -->
                                            <mat-form-field class="w-full">
                                                <mat-label>Departamento</mat-label>
                                                <input matInput [formControlName]="'departamento'"
                                                    placeholder="Departamento" />
                                            </mat-form-field>

                                            <!-- Desktop - 1 columna -->
                                            <mat-form-field class="w-full">
                                                <mat-label>Desktop</mat-label>
                                                <input matInput [formControlName]="'desktop'" placeholder="Desktop" />
                                            </mat-form-field>

                                            <!-- Usuario - Ocupa 2 columnas en desktop -->
                                            <div class="sm:col-span-2">
                                                <mat-form-field class="w-full">
                                                    <mat-label>Usuario</mat-label>
                                                    <input matInput [formControlName]="'usuario'" placeholder="Usuario"
                                                        autocomplete="off" />
                                                </mat-form-field>
                                            </div>

                                            <!-- Nueva contraseña - 1 columna -->
                                            <mat-form-field class="w-full">
                                                <mat-label>Nueva contraseña</mat-label>
                                                <input matInput [type]="showPassword ? 'text' : 'password'"
                                                    formControlName="password"
                                                    placeholder="Dejar en blanco si no cambia" autocomplete="off"
                                                    (paste)="blockPaste($event)" />
                                                <button mat-icon-button matSuffix type="button"
                                                    (click)="togglePasswordVisibility()">
                                                    <mat-icon>
                                                        {{ showPassword ? 'visibility_off' : 'visibility' }}
                                                    </mat-icon>
                                                </button>
                                                <mat-hint>Dejar vacío si no deseas cambiar la contraseña</mat-hint>
                                                <mat-error
                                                    *ngIf="selectedUsuarioForm.get('password')?.hasError('minlength') && selectedUsuarioForm.get('password')?.touched">
                                                    La contraseña debe tener al menos 6 caracteres.
                                                </mat-error>
                                            </mat-form-field>

                                            <!-- Confirmar contraseña - 1 columna -->
                                            <mat-form-field class="w-full">
                                                <mat-label>Confirmar contraseña</mat-label>
                                                <input matInput [type]="showPasswordConfirmation ? 'text' : 'password'"
                                                    formControlName="password_confirmation"
                                                    placeholder="Repite la nueva contraseña" autocomplete="off"
                                                    (paste)="blockPaste($event)" />
                                                <button mat-icon-button matSuffix type="button"
                                                    (click)="togglePasswordConfirmationVisibility()">
                                                    <mat-icon>
                                                        {{ showPasswordConfirmation ? 'visibility_off' : 'visibility' }}
                                                    </mat-icon>
                                                </button>
                                                <mat-error *ngIf="passwordsDontMatch()">
                                                    Las contraseñas no coinciden.
                                                </mat-error>
                                            </mat-form-field>

                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Botones de acción - Responsive layout -->
                            <div
                                class="flex flex-col gap-3 border-t px-4 py-4 sm:flex-row sm:items-center sm:justify-between sm:px-6 lg:px-8">
                                <button class="order-2 sm:order-1" mat-button [color]="'warn'"
                                    (click)="deleteSelectedUsuario()">
                                    <mat-icon class="mr-2">delete</mat-icon>
                                    Eliminar
                                </button>

                                <div class="order-1 flex flex-col items-center gap-3 sm:order-2 sm:flex-row">
                                    @if (flashMessage) {
                                    <div class="flex items-center">
                                        @if (flashMessage === 'success') {
                                        <mat-icon class="text-green-500" [svgIcon]="'heroicons_outline:check'">
                                        </mat-icon>
                                        <span class="ml-2 text-sm">Usuario actualizado</span>
                                        }
                                        @if (flashMessage === 'error') {
                                        <mat-icon class="text-red-500" [svgIcon]="'heroicons_outline:x-mark'">
                                        </mat-icon>
                                        <span class="ml-2 text-sm">¡Ocurrió un error, intenta de nuevo!</span>
                                        }
                                    </div>
                                    }
                                    <button mat-flat-button [color]="'primary'" (click)="updateSelectedUsuario()"
                                        class="w-full sm:w-auto">
                                        <mat-icon class="mr-2">save</mat-icon>
                                        Actualizar
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </ng-template>
        </div>
    </div>
</div>
