<div class="flex min-w-0 flex-auto flex-col dark:bg-gray-900">

  <!-- ENCABEZADO -->
  <div class="bg-card flex flex-0 flex-col px-4 pt-4 sm:flex-row sm:items-center sm:justify-between sm:px-10 sm:pt-4 dark:bg-transparent">
    <div class="min-w-0 flex-1">
      <h2 class="truncate text-3xl font-extrabold leading-7 tracking-tight sm:leading-10 md:text-4xl">
        Estados de cuenta
      </h2>
      <p class="mt-2 text-sm text-gray-600 dark:text-white">
        Consulta y descarga los estados de tus clientes
      </p>
    </div>

    <!-- Tarjetas de resumen -->
    <ng-container *ngIf="!isLoading">
      <div class="mt-4 grid grid-cols-3 gap-2 sm:ml-6 sm:mt-0 sm:flex sm:flex-shrink-0 sm:gap-4">
        <div class="min-w-0 rounded-lg bg-blue-200 p-2 sm:p-4 dark:bg-blue-900/20">
          <div class="text-center text-xs text-blue-600 sm:text-left dark:text-blue-400">Cargos</div>
          <div class="mt-0.5 truncate text-center text-xs font-bold text-blue-700 sm:text-left sm:text-2xl dark:text-blue-300">
            {{ totalCargos | currency: 'MXN' : 'symbol' : '1.2-2' }}
          </div>
        </div>
        <div class="min-w-0 rounded-lg bg-green-200 p-2 sm:p-4 dark:bg-green-900/20">
          <div class="text-center text-xs text-green-600 sm:text-left dark:text-green-400">Abonos</div>
          <div class="mt-0.5 truncate text-center text-xs font-bold text-green-700 sm:text-left sm:text-2xl dark:text-green-300">
            {{ totalAbonos | currency: 'MXN' : 'symbol' : '1.2-2' }}
          </div>
        </div>
        <div class="min-w-0 rounded-lg bg-red-200 p-2 sm:p-4 dark:bg-red-900/20">
          <div class="text-center text-xs text-red-600 sm:text-left dark:text-red-400">Saldo</div>
          <div class="mt-0.5 truncate text-center text-xs font-bold text-red-700 sm:text-left sm:text-2xl dark:text-red-300">
            {{ totalSaldos | currency: 'MXN' : 'symbol' : '1.2-2' }}
          </div>
        </div>
      </div>
    </ng-container>
  </div>

  <!-- FILTROS -->
  <div class="bg-white px-4 py-3 sm:border-none sm:px-10 sm:pb-0 dark:bg-gray-900">
    <div class="flex items-center gap-2">
      <!-- Búsqueda -->
      <mat-form-field class="fuse-mat-dense fuse-mat-rounded flex-1" [subscriptSizing]="'dynamic'">
        <mat-icon class="icon-size-5" matPrefix [svgIcon]="'heroicons_solid:magnifying-glass'"></mat-icon>
        <input matInput [formControl]="searchControl" autocomplete="off" placeholder="Buscar por cliente, RFC o documento..." />
      </mat-form-field>

      <!-- Filtro estado -->
      <mat-form-field class="fuse-mat-dense fuse-mat-rounded w-36" [subscriptSizing]="'dynamic'">
        <mat-select [formControl]="filtroEstado" (selectionChange)="aplicarFiltros()">
          <mat-option value="todos">Todos</mat-option>
          <mat-option value="pendiente">Pendientes</mat-option>
          <mat-option value="vencido">Vencidos</mat-option>
          <mat-option value="pagado">Pagados</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Expandir/colapsar todos -->
      <button
        mat-icon-button
        (click)="expandirTodos()"
        [matTooltip]="'Expandir / Colapsar todos'"
        class="rounded-full text-gray-600 transition-all duration-200 hover:bg-gray-200 dark:text-gray-400 dark:hover:bg-gray-700"
      >
        <mat-icon [svgIcon]="'heroicons_outline:squares-2x2'"></mat-icon>
      </button>

      <!-- Limpiar filtros -->
      <button
        *ngIf="hayFiltrosActivos()"
        mat-icon-button
        (click)="limpiarFiltros()"
        class="rounded-full text-red-600 transition-all duration-200 hover:bg-red-600 hover:text-white"
      >
        <mat-icon [svgIcon]="'heroicons_outline:x-mark'" class="hover:text-white"></mat-icon>
      </button>

      <!-- Descargar seleccionados -->
      <button
        mat-icon-button
        (click)="descargarSeleccionados()"
        [disabled]="documentosSeleccionados.size === 0"
        [matTooltip]="documentosSeleccionados.size + ' documentos seleccionados'"
        class="rounded-full text-primary-600 transition-all duration-200 hover:bg-primary-500 disabled:text-black disabled:hover:bg-transparent dark:text-white"
      >
        <mat-icon [svgIcon]="'heroicons_outline:arrow-down-tray'" class="hover:text-white"></mat-icon>
      </button>
    </div>
  </div>

  <!-- CUERPO -->
  <div class="flex flex-auto overflow-hidden">
    <div class="flex flex-auto flex-col overflow-y-auto">
      <div class="p-4 px-5 sm:p-6 md:py-4">

        <!-- Loading -->
        <ng-container *ngIf="isLoading">
          <div class="flex flex-auto flex-col items-center justify-center py-20">
            <div class="relative h-16 w-16">
              <div class="absolute inset-0 animate-spin rounded-full border-4 border-gray-200 border-t-primary dark:border-gray-700 dark:border-t-primary-400"></div>
            </div>
            <p class="mt-6 text-sm text-gray-500 dark:text-white">Cargando estados de cuenta...</p>
          </div>
        </ng-container>

        <!-- Sin resultados -->
        <ng-container *ngIf="!isLoading && clientesAgrupadosFiltrados.length === 0">
          <div class="flex flex-auto flex-col items-center justify-center py-20">
            <mat-icon class="text-gray-300 icon-size-24 dark:text-gray-700" [svgIcon]="'heroicons_outline:document-text'"></mat-icon>
            <div class="mt-6 text-2xl font-semibold tracking-tight text-black dark:text-gray-100">
              No hay estados de cuenta
            </div>
            <div class="mt-2 text-center text-sm text-gray-600 dark:text-white">
              No se encontraron estados con los filtros seleccionados
            </div>
          </div>
        </ng-container>

        <!-- Lista agrupada por cliente -->
        <ng-container *ngIf="!isLoading && clientesAgrupadosFiltrados.length > 0">
          <div class="space-y-3">

            <div
              *ngFor="let cliente of clientesAgrupadosFiltrados; trackBy: trackByCliente"
              class="overflow-hidden rounded-2xl border border-gray-100 bg-white shadow-sm dark:border-gray-800 dark:bg-gray-900"
            >

              <!-- HEADER DEL CLIENTE (accordion trigger) -->
              <div
                class="flex cursor-pointer items-center gap-3 px-4 py-4 transition-colors hover:bg-gray-50 sm:px-6 dark:hover:bg-gray-800/50"
                (click)="toggleExpandir(cliente)"
              >
                <!-- Checkbox cliente -->
                <div class="flex-shrink-0" (click)="$event.stopPropagation()">
                  <mat-checkbox
                    [checked]="clienteTodoSeleccionado(cliente)"
                    [indeterminate]="clienteParcialmenteSeleccionado(cliente)"
                    (change)="toggleSeleccionCliente(cliente)"
                  ></mat-checkbox>
                </div>

                <!-- Ícono expand/collapse -->
                <mat-icon
                  class="flex-shrink-0 text-gray-400 transition-transform duration-200 icon-size-5"
                  [class.rotate-90]="cliente.expandido"
                  [svgIcon]="'heroicons_outline:chevron-right'"
                ></mat-icon>

                <!-- Info del cliente -->
                <div class="min-w-0 flex-1">
                  <div class="flex flex-wrap items-center gap-x-3 gap-y-1">
                    <span class="text-base font-bold text-gray-900 dark:text-white">
                      {{ cliente.nombre }}
                    </span>
                    <span class="text-xs text-gray-500 dark:text-gray-400">
                      RFC: {{ cliente.rfc }}
                    </span>

                    <!-- Badge vencidos -->
                    <span
                      *ngIf="cliente.documentos_vencidos > 0"
                      class="inline-flex items-center rounded-full bg-red-100 px-2 py-0.5 text-xs font-semibold text-red-700 dark:bg-red-900/30 dark:text-red-400"
                    >
                      {{ cliente.documentos_vencidos }} vencido{{ cliente.documentos_vencidos > 1 ? 's' : '' }}
                    </span>
                  </div>

                  <!-- Resumen financiero del cliente en mobile -->
                  <div class="mt-1 flex flex-wrap gap-x-4 gap-y-1 text-xs text-gray-500 dark:text-gray-400 sm:hidden">
                    <span>{{ cliente.total_documentos }} docs</span>
                    <span class="text-red-600 font-medium">{{ cliente.total_saldo | currency: 'MXN' : 'symbol' : '1.0-0' }}</span>
                  </div>
                </div>

                <!-- Resumen numérico del cliente — visible en sm+ -->
                <div class="hidden flex-shrink-0 items-center gap-6 sm:flex">
                  <div class="text-right">
                    <div class="text-xs text-gray-400 dark:text-gray-500">Documentos</div>
                    <div class="text-sm font-semibold text-gray-700 dark:text-gray-300">
                      {{ cliente.documentos.length }}
                    </div>
                  </div>
                  <div class="text-right">
                    <div class="text-xs text-gray-400 dark:text-gray-500">Cargos</div>
                    <div class="text-sm font-semibold text-blue-700 dark:text-blue-400">
                      {{ cliente.total_cargos | currency: 'MXN' : 'symbol' : '1.0-0' }}
                    </div>
                  </div>
                  <div class="text-right">
                    <div class="text-xs text-gray-400 dark:text-gray-500">Abonos</div>
                    <div class="text-sm font-semibold text-green-600 dark:text-green-400">
                      {{ cliente.total_abonos | currency: 'MXN' : 'symbol' : '1.0-0' }}
                    </div>
                  </div>
                  <div class="text-right min-w-[7rem]">
                    <div class="text-xs text-gray-400 dark:text-gray-500">Saldo total</div>
                    <div
                      class="text-base font-bold"
                      [class.text-red-600]="cliente.total_saldo > 0"
                      [class.text-green-600]="cliente.total_saldo === 0"
                    >
                      {{ cliente.total_saldo | currency: 'MXN' : 'symbol' : '1.2-2' }}
                    </div>
                  </div>

                  <!-- Monto vencido badge -->
                  <div *ngIf="cliente.monto_vencido > 0" class="text-right min-w-[7rem]">
                    <div class="text-xs text-red-400">Vencido</div>
                    <div class="text-sm font-bold text-red-600 dark:text-red-400">
                      {{ cliente.monto_vencido | currency: 'MXN' : 'symbol' : '1.0-0' }}
                    </div>
                  </div>
                </div>
              </div>

              <!-- TABLA DE DOCUMENTOS (expandible) -->
              <div *ngIf="cliente.expandido" class="border-t border-gray-100 dark:border-gray-800">

                <!-- Header de tabla — solo visible en md+ -->
                <div class="hidden border-b border-gray-200 bg-gray-50 px-6 py-2 text-xs font-semibold uppercase tracking-wider text-gray-500 md:grid md:grid-cols-[2.5rem_1fr_1fr_1fr_1fr_1fr_auto] md:items-center md:gap-4 dark:border-gray-700 dark:bg-gray-800/50 dark:text-gray-400">
                  <div></div>
                  <div>Documento</div>
                  <div>Fecha Aplic.</div>
                  <div>Vencimiento</div>
                  <div class="text-right">Cargos</div>
                  <div class="text-right">Abonos</div>
                  <div class="text-right">Saldo</div>
                </div>

                <!-- Filas de documentos -->
                <div class="divide-y divide-gray-50 dark:divide-gray-800">
                  <div
                    *ngFor="let ec of cliente.documentos; trackBy: trackByDocumento"
                    class="px-4 py-3 hover:bg-gray-50 sm:px-6 md:grid md:grid-cols-[2.5rem_1fr_1fr_1fr_1fr_1fr_auto] md:items-center md:gap-4 dark:hover:bg-gray-800/30"
                  >
                    <!-- Checkbox -->
                    <div class="hidden md:flex md:items-center md:justify-center">
                      <mat-checkbox
                        [checked]="documentosSeleccionados.has(ec.documento)"
                        (change)="toggleSeleccion(ec.documento)"
                      ></mat-checkbox>
                    </div>

                    <!-- Mobile layout -->
                    <div class="flex items-start gap-3 md:contents">
                      <!-- Checkbox mobile -->
                      <div class="flex items-center pt-0.5 md:hidden">
                        <mat-checkbox
                          [checked]="documentosSeleccionados.has(ec.documento)"
                          (change)="toggleSeleccion(ec.documento)"
                        ></mat-checkbox>
                      </div>

                      <div class="flex flex-1 flex-col gap-2 md:contents">
                        <!-- Documento -->
                        <div>
                          <div class="text-sm font-semibold text-gray-900 dark:text-gray-100">
                            {{ ec.documento }}
                          </div>
                        </div>

                        <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm md:contents">
                          <!-- Fecha Aplicación -->
                          <div>
                            <div class="text-xs text-gray-400 md:hidden">Fecha Aplic.</div>
                            <div class="text-gray-700 dark:text-gray-300">{{ ec.fecha_aplicacion | date: 'dd/MM/yyyy' }}</div>
                          </div>

                          <!-- Vencimiento -->
                          <div>
                            <div class="text-xs text-gray-400 md:hidden">Vencimiento</div>
                            <div
                              class="text-sm"
                              [class.text-red-600]="ec.saldo > 0 && getDiasVencimiento(ec.fecha_vencimiento) < 0"
                              [class.text-yellow-600]="ec.saldo > 0 && getDiasVencimiento(ec.fecha_vencimiento) >= 0 && getDiasVencimiento(ec.fecha_vencimiento) <= 7"
                              [class.text-gray-700]="ec.saldo === 0 || getDiasVencimiento(ec.fecha_vencimiento) > 7"
                              [class.dark:text-gray-300]="ec.saldo === 0 || getDiasVencimiento(ec.fecha_vencimiento) > 7"
                            >
                              {{ ec.fecha_vencimiento | date: 'dd/MM/yyyy' }}
                            </div>
                          </div>

                          <!-- Cargos -->
                          <div>
                            <div class="text-xs text-gray-400 md:hidden">Cargos</div>
                            <div class="font-medium text-blue-800 md:text-right dark:text-blue-400">
                              {{ ec.cargos | currency: 'MXN' }}
                            </div>
                          </div>

                          <!-- Abonos -->
                          <div>
                            <div class="text-xs text-gray-400 md:hidden">Abonos</div>
                            <div class="text-green-600 md:text-right dark:text-green-400">
                              {{ ec.abonos | currency: 'MXN' }}
                            </div>
                          </div>

                          <!-- Saldo -->
                          <div class="col-span-2 md:col-auto">
                            <div class="text-xs text-gray-400 md:hidden">Saldo</div>
                            <div
                              class="text-base font-bold md:text-right md:text-sm"
                              [class.text-red-600]="ec.saldo > 0"
                              [class.text-green-600]="ec.saldo === 0"
                            >
                              {{ ec.saldo | currency: 'MXN' : 'symbol' : '1.2-2' }}
                            </div>
                          </div>

                          <!-- Acciones -->
                          <!-- <div class="col-span-2 flex justify-end md:col-auto">
                            <button
                              mat-icon-button
                              [matTooltip]="'Descargar PDF'"
                              (click)="descargarPDF(ec.documento)"
                              class="h-8 w-8 text-gray-400 hover:text-primary-600"
                            >
                              <mat-icon class="icon-size-4" [svgIcon]="'heroicons_outline:arrow-down-tray'"></mat-icon>
                            </button>
                          </div> -->
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Footer del cliente con subtotales -->
                <div class="flex flex-wrap items-center justify-between gap-3 border-t border-gray-200 bg-gray-50 px-6 py-3 dark:border-gray-700 dark:bg-gray-800/50">
                  <span class="text-xs text-gray-500 dark:text-gray-400">
                    {{ cliente.documentos.length }} documento{{ cliente.documentos.length !== 1 ? 's' : '' }}
                    <ng-container *ngIf="cliente.documentos_vencidos > 0">
                      · <span class="text-red-500">{{ cliente.documentos_vencidos }} vencido{{ cliente.documentos_vencidos > 1 ? 's' : '' }}</span>
                    </ng-container>
                  </span>
                  <div class="flex flex-wrap gap-x-6 gap-y-1 text-sm">
                    <span class="text-blue-700 dark:text-blue-400">
                      Cargos: <strong>{{ cliente.total_cargos | currency: 'MXN' : 'symbol' : '1.2-2' }}</strong>
                    </span>
                    <span class="text-green-600 dark:text-green-400">
                      Abonos: <strong>{{ cliente.total_abonos | currency: 'MXN' : 'symbol' : '1.2-2' }}</strong>
                    </span>
                    <span
                      class="font-bold"
                      [class.text-red-600]="cliente.total_saldo > 0"
                      [class.text-green-600]="cliente.total_saldo === 0"
                    >
                      Saldo: {{ cliente.total_saldo | currency: 'MXN' : 'symbol' : '1.2-2' }}
                    </span>
                  </div>
                </div>

              </div>
            </div>

          </div>
        </ng-container>

      </div>
    </div>
  </div>

</div>