<div class="flex min-w-0 flex-auto flex-col dark:bg-gray-900">
  <!-- ENCABEZADO -->
  <div
    class="bg-card flex flex-0 flex-col px-4 pt-4 sm:flex-row sm:items-center sm:justify-between sm:px-10 sm:pt-4 dark:bg-transparent"
  >
    <div class="min-w-0 flex-1">
      <h2
        class="truncate text-3xl font-extrabold leading-7 tracking-tight sm:leading-10 md:text-4xl"
      >
        Estados de cuenta
      </h2>
      <p class="mt-2 text-sm text-gray-600 dark:text-white">
        Consulta y descarga los estados de tus clientes
      </p>
    </div>

    <!-- Tarjetas de resumen -->
    <ng-container *ngIf="!isLoading">
      <div class="mt-4 grid grid-cols-3 gap-2 sm:ml-6 sm:mt-0 sm:flex sm:flex-shrink-0 sm:gap-4">
        <div class="min-w-0 rounded-lg bg-blue-200 p-2 sm:p-4 dark:bg-blue-900/20">
          <div class="text-center text-xs text-blue-600 sm:text-left dark:text-blue-400">
            Cargos
          </div>
          <div
            class="mt-0.5 truncate text-center text-xs font-bold text-blue-700 sm:text-left sm:text-2xl dark:text-blue-300"
          >
            {{ totalCargos | currency: 'MXN' : 'symbol' : '1.2-2' }}
          </div>
        </div>
        <div class="min-w-0 rounded-lg bg-green-200 p-2 sm:p-4 dark:bg-green-900/20">
          <div class="text-center text-xs text-green-600 sm:text-left dark:text-green-400">
            Abonos
          </div>
          <div
            class="mt-0.5 truncate text-center text-xs font-bold text-green-700 sm:text-left sm:text-2xl dark:text-green-300"
          >
            {{ totalAbonos | currency: 'MXN' : 'symbol' : '1.2-2' }}
          </div>
        </div>
        <div class="min-w-0 rounded-lg bg-red-200 p-2 sm:p-4 dark:bg-red-900/20">
          <div class="text-center text-xs text-red-600 sm:text-left dark:text-red-400">Saldo</div>
          <div
            class="mt-0.5 truncate text-center text-xs font-bold text-red-700 sm:text-left sm:text-2xl dark:text-red-300"
          >
            {{ totalSaldos | currency: 'MXN' : 'symbol' : '1.2-2' }}
          </div>
        </div>
      </div>
    </ng-container>
  </div>

  <!-- FILTROS -->
  <div class="bg-white px-4 py-3 sm:border-none sm:px-10 sm:pb-0 dark:bg-gray-900">
    <div class="flex items-center gap-2">
      <!-- Búsqueda -->
      <mat-form-field class="fuse-mat-dense fuse-mat-rounded flex-1" [subscriptSizing]="'dynamic'">
        <mat-icon
          class="icon-size-5"
          matPrefix
          [svgIcon]="'heroicons_solid:magnifying-glass'"
        ></mat-icon>
        <input
          matInput
          [formControl]="searchControl"
          autocomplete="off"
          placeholder="Buscar por cliente, RFC o documento..."
        />
      </mat-form-field>

      <!-- Filtro estado -->
      <!-- <mat-form-field class="fuse-mat-dense fuse-mat-rounded w-36" [subscriptSizing]="'dynamic'">
        <mat-select [formControl]="filtroEstado" (selectionChange)="aplicarFiltros()">
          <mat-option value="todos">Todos</mat-option>
          <mat-option value="pendiente">Pendientes</mat-option>
          <mat-option value="vencido">Vencidos</mat-option>
          <mat-option value="pagado">Pagados</mat-option>
        </mat-select>
      </mat-form-field> -->

      <!-- Expandir/colapsar todos -->
      <button
        mat-icon-button
        (click)="expandirTodos()"
        [matTooltip]="'Expandir / Colapsar todos'"
        class="hidden rounded-full text-gray-600 transition-all duration-200 hover:bg-gray-200 md:inline-flex dark:text-gray-400 dark:hover:bg-gray-700"
      >
        <mat-icon [svgIcon]="'heroicons_outline:squares-2x2'"></mat-icon>
      </button>

      <!-- Limpiar filtros -->
      <button
        *ngIf="hayFiltrosActivos()"
        mat-icon-button
        (click)="limpiarFiltros()"
        class="rounded-full text-red-600 transition-all duration-200 hover:bg-red-600 hover:text-white"
      >
        <mat-icon [svgIcon]="'heroicons_outline:x-mark'" class="hover:text-white"></mat-icon>
      </button>

      <!-- Descargar seleccionados -->
      <button
        mat-icon-button
        (click)="descargarSeleccionados()"
        [disabled]="documentosSeleccionados.size === 0"
        [matTooltip]="documentosSeleccionados.size + ' documentos seleccionados'"
        class="rounded-full text-primary-600 transition-all duration-200 hover:bg-primary-500 disabled:text-black disabled:hover:bg-transparent dark:text-white"
      >
        <mat-icon
          [svgIcon]="'heroicons_outline:arrow-down-tray'"
          class="hover:text-white"
        ></mat-icon>
      </button>
    </div>
  </div>

  <!-- CUERPO -->
  <div class="flex flex-auto overflow-hidden">
    <div class="flex flex-auto flex-col overflow-y-auto">
      <div class="p-4 px-5 sm:p-6 md:py-4">
        <!-- Loading -->
        <ng-container *ngIf="isLoading">
          <div class="flex flex-auto flex-col items-center justify-center py-20">
            <div class="relative h-16 w-16">
              <div
                class="absolute inset-0 animate-spin rounded-full border-4 border-gray-200 border-t-primary dark:border-gray-700 dark:border-t-primary-400"
              ></div>
            </div>
            <p class="mt-6 text-sm text-gray-500 dark:text-white">Cargando estados de cuenta...</p>
          </div>
        </ng-container>

        <!-- Sin resultados -->
        <ng-container *ngIf="!isLoading && clientesAgrupadosFiltrados.length === 0">
          <div class="flex flex-auto flex-col items-center justify-center py-20">
            <mat-icon
              class="text-gray-300 icon-size-24 dark:text-gray-700"
              [svgIcon]="'heroicons_outline:document-text'"
            ></mat-icon>
            <div class="mt-6 text-2xl font-semibold tracking-tight text-black dark:text-gray-100">
              No hay estados de cuenta
            </div>
            <div class="mt-2 text-center text-sm text-gray-600 dark:text-white">
              No se encontraron estados con los filtros seleccionados
            </div>
          </div>
        </ng-container>

        <!-- Lista agrupada por cliente -->
        <ng-container *ngIf="!isLoading && clientesAgrupadosFiltrados.length > 0">
          <div class="space-y-3">
            <div
              *ngFor="let cliente of clientesAgrupadosFiltrados; trackBy: trackByCliente"
              class="overflow-hidden rounded-2xl border border-gray-100 bg-white shadow-sm dark:border-gray-800 dark:bg-gray-900"
            >
              <!-- HEADER DEL CLIENTE (accordion trigger) -->
              <div
                class="cursor-pointer transition-colors hover:bg-gray-50 md:grid md:grid-cols-[2rem_1fr_7rem_9rem_9rem_11rem_1.5rem] md:items-center md:gap-3 md:px-6 md:py-4 dark:hover:bg-gray-800/50"
                (click)="toggleExpandir(cliente)"
              >
                <!-- LAYOUT MÓVIL -->
                <div class="flex items-center gap-3 px-4 py-4 md:contents">
                  <!-- Checkbox -->
                  <div class="flex-shrink-0" (click)="$event.stopPropagation()">
                    <mat-checkbox
                      [checked]="clienteTodoSeleccionado(cliente)"
                      [indeterminate]="clienteParcialmenteSeleccionado(cliente)"
                      (change)="toggleSeleccionCliente(cliente)"
                    ></mat-checkbox>
                  </div>

                  <!-- Nombre + RFC -->
                  <div class="min-w-0 flex-1">
                    <div class="flex flex-col">
                      <span class="text-base font-bold text-gray-900 dark:text-white">
                        {{ cliente.nombre }}
                      </span>
                      <span class="text-xs text-black md:text-sm dark:text-white">
                        RFC: {{ cliente.rfc }}
                      </span>
                    </div>
                  </div>

                  <!-- Saldo total (solo móvil, esquina superior derecha) -->
                  <div class="flex flex-col items-end md:hidden">
                    <span class="text-xs text-black dark:text-white">Saldo total</span>
                    <span
                      class="text-sm font-bold"
                      [class.text-red-600]="cliente.total_saldo > 0"
                      [class.text-green-600]="cliente.total_saldo === 0"
                    >
                      {{ cliente.total_saldo | currency: 'MXN' : 'symbol' : '1.0-0' }}
                    </span>
                  </div>

                  <!-- Chevron (solo móvil, centrado verticalmente) -->
                  <mat-icon
                    class="flex-shrink-0 text-gray-400 transition-transform duration-200 icon-size-5 md:hidden"
                    [class.rotate-90]="cliente.expandido"
                    [svgIcon]="'heroicons_outline:chevron-right'"
                  ></mat-icon>
                </div>

                <!-- COLUMNAS DESKTOP (ocultas en móvil) -->
                <div class="hidden text-right md:block">
                  <div class="text-base font-semibold text-black dark:text-white">Documentos</div>
                  <div class="text-sm text-black dark:text-white">
                    {{ cliente.documentos.length }}
                  </div>
                </div>
                <div class="hidden text-right md:block">
                  <div class="text-base font-semibold text-black dark:text-white">Cargos</div>
                  <div class="text-sm text-blue-700 dark:text-blue-400">
                    {{ cliente.total_cargos | currency: 'MXN' : 'symbol' : '1.0-0' }}
                  </div>
                </div>
                <div class="hidden text-right md:block">
                  <div class="text-base font-semibold text-black dark:text-white">Abonos</div>
                  <div class="text-sm text-green-600 dark:text-green-400">
                    {{ cliente.total_abonos | currency: 'MXN' : 'symbol' : '1.0-0' }}
                  </div>
                </div>
                <div class="hidden text-right md:block">
                  <div class="text-base font-semibold text-black dark:text-white">Saldo total</div>
                  <div
                    class="text-sm"
                    [class.text-red-600]="cliente.total_saldo > 0"
                    [class.text-green-600]="cliente.total_saldo === 0"
                  >
                    {{ cliente.total_saldo | currency: 'MXN' : 'symbol' : '1.2-2' }}
                  </div>
                </div>

                <!-- Chevron desktop -->
                <mat-icon
                  class="hidden flex-shrink-0 text-gray-400 transition-transform duration-200 icon-size-5 md:block"
                  [class.rotate-90]="cliente.expandido"
                  [svgIcon]="'heroicons_outline:chevron-right'"
                ></mat-icon>
              </div>

              <!-- TABLA DE DOCUMENTOS (expandible) -->
              <div *ngIf="cliente.expandido" class="border-t border-gray-100 dark:border-gray-800">
                <!-- Header de tabla — solo visible en md+ -->
                <div
                  class="hidden border-b border-gray-200 bg-gray-50 px-6 py-2 text-base font-semibold tracking-wider text-black md:grid md:items-center md:gap-4 dark:border-gray-700 dark:bg-gray-800/50 dark:text-white"
                  style="grid-template-columns: 2.5rem 2fr 1.2fr 1.2fr 1.4fr 1.2fr 1.4fr"
                >
                  <div></div>
                  <div>No. factura</div>
                  <div>Fecha Aplic.</div>
                  <div>Vencimiento</div>
                  <div class="text-right">Cargos</div>
                  <div class="text-right">Abonos</div>
                  <div class="text-right">Saldo</div>
                </div>

                <!-- Filas de documentos -->
                <div class="divide-y divide-gray-50 dark:divide-gray-800">
                  <div
                    *ngFor="let ec of cliente.documentos; trackBy: trackByDocumento"
                    class=" md:py-3 hover:bg-gray-50 sm:px-6 md:grid md:items-center md:gap-4 dark:hover:bg-gray-800/30"
                    style="grid-template-columns: 2.5rem 2fr 1.2fr 1.2fr 1.4fr 1.2fr 1.4fr"
                  >
                    <!-- Checkbox -->
                    <div class="hidden md:flex md:items-center md:justify-center">
                      <mat-checkbox
                        [checked]="documentosSeleccionados.has(ec.documento)"
                        (change)="toggleSeleccion(ec.documento)"
                      ></mat-checkbox>
                    </div>

                    <!-- LAYOUT MÓVIL (oculto en md+) -->
                    <div class="flex flex-col px-3 py-3 md:hidden">
                      <!-- Fila superior: checkbox + No. factura + fechas -->
                      <div class="flex items-center gap-2">
                        <!-- Checkbox compacto -->
                        <div class="w-5 flex-shrink-0" (click)="$event.stopPropagation()">
                          <mat-checkbox
                            [checked]="documentosSeleccionados.has(ec.documento)"
                            (change)="toggleSeleccion(ec.documento)"
                          ></mat-checkbox>
                        </div>

                        <!-- No. factura + fechas en una sola línea o apiladas -->
                        <div class="flex min-w-0 flex-1 flex-col pl-5">
                          <span class="truncate text-xs text-black dark:text-white">
                            No. factura: {{ ec.documento }}
                          </span>
                          <div class="mt-0.5 flex gap-3">
                            <span class="text-xs text-black dark:text-white">
                              Aplic: {{ ec.fecha_aplicacion | date: 'dd/MM/yy' }}
                            </span>
                            <span class="text-xs text-black dark:text-white">
                              Vence: {{ ec.fecha_vencimiento | date: 'dd/MM/yy' }}
                            </span>
                          </div>
                        </div>
                      </div>

                      <!-- Footer del documento: cargos, abonos, saldo -->
                      <div
                        class="mt-2 flex items-center justify-between rounded-lg bg-gray-50 px-2 py-1.5 dark:bg-gray-800/50"
                      >
                        <div class="flex flex-col items-center">
                          <span class="text-xs text-black dark:text-white">Cargos</span>
                          <span class="text-xs font-medium text-blue-800 dark:text-blue-400">
                            {{ ec.cargos | currency: 'MXN' : 'symbol' : '1.0-0' }}
                          </span>
                        </div>
                        <div class="flex flex-col items-center">
                          <span class="text-xs text-black dark:text-white">Abonos</span>
                          <span class="text-xs font-medium text-green-600 dark:text-green-400">
                            {{ ec.abonos | currency: 'MXN' : 'symbol' : '1.0-0' }}
                          </span>
                        </div>
                        <div class="flex flex-col items-center">
                          <span class="text-xs text-black dark:text-white">Saldo</span>
                          <span
                            class="text-xs font-bold"
                            [class.text-red-600]="ec.saldo > 0"
                            [class.text-green-600]="ec.saldo === 0"
                          >
                            {{ ec.saldo | currency: 'MXN' : 'symbol' : '1.2-2' }}
                          </span>
                        </div>
                      </div>
                    </div>

                    <!-- COLUMNAS DESKTOP (md:contents) -->
                    <div class="hidden md:contents">
                      <!-- No. factura -->
                      <div class="text-sm text-black dark:text-white">{{ ec.documento }}</div>

                      <!-- Fecha Aplic -->
                      <div class="text-sm text-black dark:text-white">
                        {{ ec.fecha_aplicacion | date: 'dd/MM/yyyy' }}
                      </div>

                      <!-- Vencimiento -->
                      <div class="text-sm text-black dark:text-white">
                        {{ ec.fecha_vencimiento | date: 'dd/MM/yyyy' }}
                      </div>

                      <!-- Cargos -->
                      <div class="text-right text-sm text-blue-800 dark:text-blue-400">
                        {{ ec.cargos | currency: 'MXN' }}
                      </div>

                      <!-- Abonos -->
                      <div class="text-right text-sm text-green-600 dark:text-green-400">
                        {{ ec.abonos | currency: 'MXN' }}
                      </div>

                      <!-- Saldo -->
                      <div
                        class="text-right text-sm font-bold"
                        [class.text-red-600]="ec.saldo > 0"
                        [class.text-green-600]="ec.saldo === 0"
                      >
                        {{ ec.saldo | currency: 'MXN' : 'symbol' : '1.2-2' }}
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Footer del cliente con subtotales -->
                <div
                  class="flex flex-wrap items-center justify-between gap-3 border-t border-gray-200 bg-gray-50 px-6 py-3 dark:border-gray-700 dark:bg-gray-800/50"
                >
                  <span class="text-xs text-black dark:text-white">
                    {{ cliente.documentos.length }} documento{{
                      cliente.documentos.length !== 1 ? 's' : ''
                    }}
                    <ng-container *ngIf="cliente.documentos_vencidos > 0">
                      ·
                      <span class="text-red-500"
                        >{{ cliente.documentos_vencidos }} vencido{{
                          cliente.documentos_vencidos > 1 ? 's' : ''
                        }}</span
                      >
                    </ng-container>
                  </span>
                  <div class="flex flex-wrap gap-x-6 gap-y-1 text-sm">
                    <span class="text-blue-700 dark:text-blue-400">
                      Cargos:
                      <strong>{{
                        cliente.total_cargos | currency: 'MXN' : 'symbol' : '1.2-2'
                      }}</strong>
                    </span>
                    <span class="text-green-600 dark:text-green-400">
                      Abonos:
                      <strong>{{
                        cliente.total_abonos | currency: 'MXN' : 'symbol' : '1.2-2'
                      }}</strong>
                    </span>
                    <span
                      class="font-bold"
                      [class.text-red-600]="cliente.total_saldo > 0"
                      [class.text-green-600]="cliente.total_saldo === 0"
                    >
                      Saldo: {{ cliente.total_saldo | currency: 'MXN' : 'symbol' : '1.2-2' }}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </ng-container>
      </div>
    </div>
  </div>
</div>
