<div class="flex min-w-0 flex-auto flex-col">

  <!-- ===== HEADER ===== -->
  <div class="bg-card flex flex-0 flex-col border-b px-6 py-6 sm:flex-row sm:items-center sm:justify-between sm:px-10 sm:py-8 dark:bg-transparent">
    <div class="min-w-0 flex-1">
      <h2 class="truncate text-3xl font-extrabold leading-7 tracking-tight sm:leading-10 md:text-4xl">
        Pedidos por cliente
      </h2>
      <p class="mt-2 text-sm text-gray-600 dark:text-white">
        Consulta los pedidos agrupados por cada uno de tus clientes
      </p>
    </div>

    <!-- Filtros PC -->
    <div class="mt-5 hidden flex-wrap items-center gap-3 sm:mt-0 sm:flex">
      <mat-form-field class="fuse-mat-dense fuse-mat-rounded min-w-56" [subscriptSizing]="'dynamic'">
        <mat-icon class="icon-size-4" matPrefix svgIcon="heroicons_outline:magnifying-glass"></mat-icon>
        <input matInput [formControl]="searchControl" autocomplete="off" placeholder="Cliente, pedido, referencia…" />
        <button *ngIf="searchControl.value" matSuffix mat-icon-button (click)="searchControl.setValue('')">
          <mat-icon class="icon-size-4" svgIcon="heroicons_outline:x-mark"></mat-icon>
        </button>
      </mat-form-field>

      <div class="relative">
        <button mat-stroked-button
          class="h-10 rounded-3xl border-2 bg-primary-500 px-5 transition-all hover:border-primary/40"
          (click)="togglePanelFiltrosPc()">
          <span class="flex w-full items-center gap-2">
            <mat-icon class="text-white icon-size-5" svgIcon="heroicons_outline:adjustments-horizontal"></mat-icon>
            <span class="text-sm font-medium text-white">Filtros</span>
            <span *ngIf="filtrosActivosCount() > 0"
              class="ml-1 rounded-full bg-white px-2 py-0.5 text-xs font-semibold leading-none text-primary">
              {{ filtrosActivosCount() }}
            </span>
            <mat-icon class="ml-auto text-white transition-transform icon-size-4"
              [class.rotate-180]="mostrarPanelFiltrosPc"
              svgIcon="heroicons_outline:chevron-down"></mat-icon>
          </span>
        </button>

        <!-- Panel PC -->
        <div *ngIf="mostrarPanelFiltrosPc"
          class="absolute right-0 top-full z-50 mt-2 w-80 rounded-2xl border-2 bg-white shadow-2xl dark:bg-gray-800"
          [@slideDown]>
          <div class="border-b p-4">
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-semibold">Filtros</h3>
              <button mat-icon-button (click)="togglePanelFiltrosPc()">
                <mat-icon class="icon-size-5" svgIcon="heroicons_outline:x-mark"></mat-icon>
              </button>
            </div>
          </div>
          <div class="space-y-4 p-4">
            <div>
              <p class="mb-1 text-xs font-semibold text-gray-500">Estado</p>
              <mat-form-field class="w-full" appearance="outline">
                <mat-select [formControl]="estadoControl">
                  <mat-option *ngFor="let op of opcionesEstado" [value]="op.value">{{ op.label }}</mat-option>
                </mat-select>
              </mat-form-field>
            </div>
            <div>
              <p class="mb-1 text-xs font-semibold text-gray-500">Condición de pago</p>
              <mat-form-field class="w-full" appearance="outline">
                <mat-select [formControl]="condicionControl">
                  <mat-option *ngFor="let op of opcionesCondicion" [value]="op.value">{{ op.label }}</mat-option>
                </mat-select>
              </mat-form-field>
            </div>
          </div>
          <div class="border-t bg-gray-50 p-4 dark:bg-gray-900/50">
            <div class="flex gap-3">
              <button mat-button class="h-10 flex-1 rounded-xl text-red-600" (click)="limpiarFiltros()">Limpiar</button>
              <button mat-flat-button color="primary" class="h-10 flex-1 rounded-xl" (click)="aplicarFiltrosPc()">Aplicar</button>
            </div>
          </div>
        </div>
      </div>

      <button mat-icon-button matTooltip="Recargar" (click)="cargarPedidos()">
        <mat-icon class="icon-size-5" svgIcon="heroicons_outline:arrow-path"></mat-icon>
      </button>
    </div>
  </div>

  <!-- Overlay PC -->
  <div *ngIf="mostrarPanelFiltrosPc" class="fixed inset-0 z-40" (click)="togglePanelFiltrosPc()"></div>

  <!-- ===== BARRA MÓVIL ===== -->
  <div class="sticky top-0 z-30 bg-white sm:hidden dark:bg-gray-900">
    <div class="flex items-center gap-2 px-3 py-2">
      <mat-form-field class="fuse-mat-dense flex-1" appearance="outline" [subscriptSizing]="'dynamic'">
        <mat-icon matPrefix class="text-gray-400 icon-size-5" svgIcon="heroicons_outline:magnifying-glass"></mat-icon>
        <input matInput [formControl]="searchControl" autocomplete="off" placeholder="Buscar…" />
      </mat-form-field>
      <button mat-mini-fab color="primary" (click)="togglePanelFiltros()"
        [matBadge]="filtrosActivosCount()" matBadgeSize="small" matBadgeColor="accent"
        [matBadgeHidden]="filtrosActivosCount() === 0">
        <mat-icon svgIcon="heroicons_outline:adjustments-horizontal"></mat-icon>
      </button>
    </div>
  </div>

  <!-- Overlay móvil -->
  <div *ngIf="mostrarPanelFiltros" class="fixed inset-0 z-40 bg-black/60 backdrop-blur-sm sm:hidden"
    (click)="togglePanelFiltros()" [@fadeIn]></div>

  <!-- Panel móvil -->
  <div *ngIf="mostrarPanelFiltros"
    class="bg-card fixed bottom-0 left-0 right-0 z-50 flex max-h-[85vh] flex-col rounded-t-3xl shadow-2xl sm:hidden">
    <div class="flex items-center justify-between border-b p-4">
      <h2 class="text-lg font-semibold">Filtros</h2>
      <button mat-icon-button (click)="togglePanelFiltros()">
        <mat-icon svgIcon="heroicons_outline:x-mark"></mat-icon>
      </button>
    </div>
    <div class="flex-1 space-y-4 overflow-y-auto p-4">
      <mat-form-field class="w-full" appearance="outline">
        <mat-label>Estado</mat-label>
        <mat-select [formControl]="estadoControl">
          <mat-option *ngFor="let op of opcionesEstado" [value]="op.value">{{ op.label }}</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field class="w-full" appearance="outline">
        <mat-label>Condición</mat-label>
        <mat-select [formControl]="condicionControl">
          <mat-option *ngFor="let op of opcionesCondicion" [value]="op.value">{{ op.label }}</mat-option>
        </mat-select>
      </mat-form-field>
    </div>
    <div class="bg-card border-t p-4">
      <div class="flex gap-2">
        <button mat-stroked-button class="h-11 flex-1 rounded-full" (click)="limpiarFiltros()">Limpiar</button>
        <button mat-flat-button color="primary" class="h-11 flex-1 rounded-full" (click)="aplicarFiltrosMovil()">Aplicar</button>
      </div>
    </div>
  </div>

  <!-- ===== CONTENIDO ===== -->
  <div class="flex flex-auto overflow-hidden">
    <div class="flex flex-auto flex-col overflow-y-auto px-4 pb-20 sm:px-8">

      <!-- Loading -->
      <ng-container *ngIf="cargando()">
        <div class="flex flex-auto flex-col items-center justify-center py-20">
          <div class="relative h-16 w-16">
            <div class="absolute inset-0 animate-spin rounded-full border-4 border-gray-200 border-t-primary dark:border-gray-700 dark:border-t-primary-400"></div>
          </div>
          <p class="mt-6 text-sm text-gray-500 dark:text-white">Cargando pedidos...</p>
        </div>
      </ng-container>

      <!-- Vacío -->
      <div *ngIf="!cargando() && clientesConPedidos().length === 0"
        class="flex flex-col items-center justify-center py-20 text-center">
        <mat-icon svgIcon="heroicons_outline:inbox" class="mb-3 text-gray-300 icon-size-16 dark:text-gray-600"></mat-icon>
        <p class="text-default text-base font-bold">No se encontraron pedidos</p>
        <p class="text-secondary mt-1 text-sm">Intenta cambiar los filtros de búsqueda</p>
        <button mat-stroked-button class="mt-4" (click)="limpiarFiltros()">
          <mat-icon svgIcon="heroicons_outline:arrow-path" class="mr-1 icon-size-4"></mat-icon>
          Limpiar filtros
        </button>
      </div>

      <!-- ===== LISTA AGRUPADA POR CLIENTE ===== -->
      <div *ngIf="!cargando()" class="mt-4 flex flex-col gap-4">
        <div *ngFor="let cliente of clientesConPedidos(); trackBy: trackByClie"
          class="bg-card overflow-hidden rounded-2xl border shadow-sm transition-all duration-200 dark:border-gray-700"
          [class.ring-2]="estaClienteExpandido(cliente.cve_clie)"
          [class.ring-primary]="estaClienteExpandido(cliente.cve_clie)">

          <!-- ── Cabecera del cliente ── -->
          <div class="flex cursor-pointer select-none items-center gap-4 px-5 py-4 hover:bg-hover"
            (click)="toggleCliente(cliente.cve_clie)">

            <!-- Ícono cliente -->
            <div class="flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full bg-primary/10">
              <mat-icon class="text-primary icon-size-5" svgIcon="heroicons_outline:building-office-2"></mat-icon>
            </div>

            <!-- Info -->
            <div class="min-w-0 flex-1">
              <p class="truncate text-base font-bold">{{ cliente.nombre }}</p>
              <p class="text-secondary text-xs">Clave: {{ cliente.cve_clie }}</p>
            </div>

            <!-- Badges resumen -->
            <div class="hidden items-center gap-2 sm:flex">
              <span class="rounded-full bg-gray-100 px-2.5 py-0.5 text-xs font-semibold dark:bg-gray-700">
                {{ cliente.totalPedidos }} pedido(s)
              </span>
              <span *ngIf="cliente.completos > 0"
                class="rounded-full bg-green-100 px-2.5 py-0.5 text-xs font-semibold text-green-700 dark:bg-green-900/30 dark:text-green-400">
                {{ cliente.completos }} completo(s)
              </span>
              <span *ngIf="cliente.parciales > 0"
                class="rounded-full bg-amber-100 px-2.5 py-0.5 text-xs font-semibold text-amber-700 dark:bg-amber-900/30 dark:text-amber-400">
                {{ cliente.parciales }} parcial(es)
              </span>
              <span *ngIf="cliente.sinDef > 0"
                class="rounded-full bg-gray-100 px-2.5 py-0.5 text-xs font-semibold text-gray-500 dark:bg-gray-700">
                {{ cliente.sinDef }} sin def.
              </span>
            </div>

            <!-- Chevron -->
            <mat-icon class="flex-shrink-0 text-gray-400 transition-transform duration-200 icon-size-5"
              [class.rotate-180]="estaClienteExpandido(cliente.cve_clie)"
              svgIcon="heroicons_outline:chevron-down"></mat-icon>
          </div>

          <!-- ── Pedidos del cliente ── -->
          <div *ngIf="estaClienteExpandido(cliente.cve_clie)"
            class="border-t px-4 pb-4 pt-3 dark:border-gray-700">

            <div class="flex flex-col gap-2">
              <div *ngFor="let pedido of cliente.pedidos; trackBy: trackByCve"
                class="overflow-hidden rounded-xl border dark:border-gray-700"
                [class.border-primary]="estaExpandido(pedido.cve_ped)">

                <!-- Cabecera pedido -->
                <div class="flex cursor-pointer select-none items-center gap-3 bg-gray-50 px-4 py-3 hover:bg-gray-100 dark:bg-gray-800/50 dark:hover:bg-gray-700/50"
                  (click)="togglePedido(pedido.cve_ped)">

                  <div class="min-w-0 flex-1">
                    <span class="text-sm font-bold">Pedido: {{ pedido.cve_ped }}</span>
                    <span *ngIf="pedido.referencia" class="text-secondary ml-2 text-xs">
                      — {{ pedido.referencia }}
                    </span>
                  </div>

                  <!-- Fecha elab -->
                  <div *ngIf="pedido.fecha_elab" class="text-secondary hidden items-center gap-1 text-xs sm:flex">
                    <mat-icon class="icon-size-3.5" svgIcon="heroicons_outline:calendar"></mat-icon>
                    {{ pedido.fecha_elab }}
                  </div>

                  <!-- Condicion -->
                  <div class="text-secondary hidden items-center gap-1 text-xs md:flex">
                    <mat-icon class="icon-size-3.5" svgIcon="heroicons_outline:credit-card"></mat-icon>
                    {{ pedido.condicion || 'Sin definir' }}
                  </div>

                  <!-- Status badge -->
                  <span class="hidden rounded-full px-2 py-0.5 text-xs font-semibold sm:inline-flex"
                    [class.bg-green-100]="pedido.status === 'Completo'"
                    [class.text-green-700]="pedido.status === 'Completo'"
                    [class.bg-amber-100]="pedido.status === 'Parcial'"
                    [class.text-amber-700]="pedido.status === 'Parcial'"
                    [class.bg-gray-100]="pedido.status !== 'Completo' && pedido.status !== 'Parcial'"
                    [class.text-gray-600]="pedido.status !== 'Completo' && pedido.status !== 'Parcial'">
                    {{ pedido.status || 'Sin def.' }}
                  </span>

                  <!-- Botón PDF -->
                  <button mat-icon-button class="text-secondary flex-shrink-0"
                    matTooltip="Descargar PDF"
                    [disabled]="descargando() === pedido.cve_ped"
                    (click)="$event.stopPropagation(); descargarPDF(pedido.cve_ped)">
                    <mat-icon class="icon-size-5"
                      [svgIcon]="descargando() === pedido.cve_ped
                        ? 'heroicons_outline:arrow-path'
                        : 'heroicons_outline:arrow-down-tray'">
                    </mat-icon>
                  </button>

                  <mat-icon class="flex-shrink-0 text-gray-400 transition-transform duration-200 icon-size-4"
                    [class.rotate-180]="estaExpandido(pedido.cve_ped)"
                    svgIcon="heroicons_outline:chevron-down"></mat-icon>
                </div>

                <!-- Detalle del pedido -->
                <div *ngIf="estaExpandido(pedido.cve_ped)" class="border-t px-4 pb-4 pt-3 dark:border-gray-700">

                  <!-- Meta -->
                  <div class="mb-4 flex flex-wrap gap-4 rounded-xl bg-gray-50 px-4 py-3 dark:bg-gray-800/40">
                    <div *ngIf="pedido.fecha_elab" class="flex items-center gap-1.5">
                      <mat-icon class="text-gray-400 icon-size-4" svgIcon="heroicons_outline:calendar"></mat-icon>
                      <span class="text-secondary text-xs">Elab.</span>
                      <span class="text-xs font-semibold">{{ pedido.fecha_elab }}</span>
                    </div>
                    <div *ngIf="pedido.fecha_entrega" class="flex items-center gap-1.5">
                      <mat-icon class="text-gray-400 icon-size-4" svgIcon="heroicons_outline:truck"></mat-icon>
                      <span class="text-secondary text-xs">Entrega</span>
                      <span class="text-xs font-semibold">{{ pedido.fecha_entrega }}</span>
                    </div>
                    <div *ngIf="pedido.fecha_pago" class="flex items-center gap-1.5">
                      <mat-icon class="text-gray-400 icon-size-4" svgIcon="heroicons_outline:banknotes"></mat-icon>
                      <span class="text-secondary text-xs">Pago</span>
                      <span class="text-xs font-semibold">{{ pedido.fecha_pago }}</span>
                    </div>
                    <div *ngIf="pedido.observaciones" class="flex items-center gap-1.5">
                      <mat-icon class="text-gray-400 icon-size-4" svgIcon="heroicons_outline:chat-bubble-left"></mat-icon>
                      <span class="text-secondary text-xs">{{ pedido.observaciones }}</span>
                    </div>
                  </div>

                  <!-- Artículos -->
                  <div *ngIf="pedido.articulos?.length > 0" class="mb-3">
                    <p class="text-secondary mb-2 text-xs font-bold uppercase tracking-wider">Artículos</p>
                    <div class="flex flex-col gap-1">
                      <div *ngFor="let a of pedido.articulos"
                        class="flex items-center justify-between border-l-4 border-primary bg-primary/5 py-2 pl-3 pr-4">
                        <span class="text-sm font-medium">{{ a.ARTICULO }}</span>
                        <span class="text-sm font-extrabold tabular-nums text-primary">{{ a.CANTIDAD }} kg</span>
                      </div>
                    </div>
                  </div>

                  <!-- Cardigans -->
                  <div *ngIf="pedido.cardigans?.length > 0">
                    <p class="text-secondary mb-2 text-xs font-bold uppercase tracking-wider">Cardigans</p>
                    <div class="flex flex-col gap-1">
                      <div *ngFor="let c of pedido.cardigans"
                        class="flex items-center justify-between border-l-4 border-purple-400 bg-purple-50 py-2 pl-3 pr-4 dark:bg-purple-900/20">
                        <span class="text-sm font-medium">{{ c.DESCRIPCION }}</span>
                        <span class="text-sm font-extrabold tabular-nums text-purple-600 dark:text-purple-400">{{ c.CANTIDAD }} kg</span>
                      </div>
                    </div>
                  </div>

                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>