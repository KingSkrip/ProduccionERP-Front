<div
  class="fixed inset-0 z-50 flex flex-col bg-white md:relative md:inset-auto md:-m-6 md:max-h-screen md:min-w-160 md:max-w-240 dark:bg-gray-800"
>
  <!-- Header FIJO -->
  <div
    class="flex h-14 flex-shrink-0 items-center justify-between bg-primary px-4 text-on-primary md:h-16 md:px-6"
  >
    <div class="text-base font-medium md:text-lg">Nuevo mensaje</div>
    <button mat-icon-button (click)="Cancelar()" [tabIndex]="-1">
      <mat-icon class="text-current" [svgIcon]="'heroicons_outline:x-mark'"></mat-icon>
    </button>
  </div>

  <!-- CONTENIDO CON SCROLL -->
  <div class="flex-1 overflow-y-auto">
    <form *ngIf="composeForm" class="flex min-h-full flex-col p-4 md:p-6" [formGroup]="composeForm">
      <mat-form-field>
        <mat-label>Para</mat-label>
        <mat-select formControlName="para" multiple (selectionChange)="onSelectChange('para')">
          <mat-select-trigger>
            <div class="flex flex-wrap gap-2">
              @for (id of composeForm.value.para || []; track id) {
                @if (getUserById(id); as u) {
                  <div class="flex items-center gap-2 rounded-full bg-black/5 px-2 py-1">
                    <img
                      class="h-5 w-5 rounded-full object-cover"
                      [src]="userPhoto(u)"
                      (error)="onImgError($event)"
                      alt="avatar"
                    />
                    <span class="text-sm">{{ u.nombre }}</span>

                    <button
                      type="button"
                      class="ml-1 grid h-5 w-5 place-items-center rounded-full hover:bg-black/10"
                      (click)="removeFrom('para', id, $event)"
                      aria-label="Quitar"
                    >
                      ✕
                    </button>
                  </div>
                }
              }

              @if (!composeForm.value.para?.length) {
                <span class="text-sm opacity-60">Selecciona uno o varios</span>
              }
            </div>
          </mat-select-trigger>

          <!--  BUSCADOR (ngx) DENTRO DE mat-option -->
          <mat-option>
            <ngx-mat-select-search
              [formControl]="paraFilterCtrl"
              placeholderLabel="Buscar por nombre o correo..."
              noEntriesFoundLabel="No hay resultados"
            ></ngx-mat-select-search>
          </mat-option>

          <!--  LISTA FILTRADA -->
          <mat-option *ngFor="let u of filteredParaUsers" [value]="u.id">
            <div class="flex items-center gap-3">
              <img
                class="h-8 w-8 rounded-full object-cover"
                [src]="userPhoto(u)"
                (error)="onImgError($event)"
                alt="avatar"
              />
              <div class="min-w-0">
                <div class="truncate font-medium">{{ u.nombre }}</div>
                <div class="truncate text-xs opacity-60">({{ u.correo || 'sin correo' }})</div>
              </div>
            </div>
          </mat-option>
        </mat-select>

        <div class="copy-fields-toggles" matSuffix>
          @if (!copyFields.cc) {
            <span
              class="cursor-pointer select-none text-sm font-medium hover:underline dark:text-white"
              (click)="showCopyField('cc'); $event.stopPropagation()"
            >
              Cc
            </span>
          }
          @if (!copyFields.bcc) {
            <span
              class="ml-2 cursor-pointer select-none text-sm font-medium hover:underline dark:text-white"
              (click)="showCopyField('bcc'); $event.stopPropagation()"
            >
              Bcc
            </span>
          }
        </div>
      </mat-form-field>

      <!-- CC -->
      @if (copyFields.cc) {
        <mat-form-field>
          <mat-label>Cc</mat-label>

          <mat-select formControlName="cc" multiple (selectionChange)="onSelectChange('cc')">
            <mat-select-trigger>
              <div class="flex flex-wrap gap-2">
                @for (id of composeForm.value.cc || []; track id) {
                  @if (getUserById(id); as u) {
                    <div class="flex items-center gap-2 rounded-full bg-black/5 px-2 py-1">
                      <img
                        class="h-5 w-5 rounded-full object-cover"
                        [src]="userPhoto(u)"
                        (error)="onImgError($event)"
                        alt="avatar"
                      />
                      <span class="text-sm">{{ u.nombre }}</span>

                      <button
                        type="button"
                        class="ml-1 grid h-5 w-5 place-items-center rounded-full hover:bg-black/10"
                        (click)="removeFrom('cc', id, $event)"
                        aria-label="Quitar"
                      >
                        ✕
                      </button>
                    </div>
                  }
                }

                @if (!composeForm.value.cc?.length) {
                  <span class="text-sm opacity-60">Selecciona uno o varios</span>
                }
              </div>
            </mat-select-trigger>

            <mat-option>
              <ngx-mat-select-search
                [formControl]="ccFilterCtrl"
                placeholderLabel="Buscar por nombre o correo..."
                noEntriesFoundLabel="No hay resultados"
              ></ngx-mat-select-search>
            </mat-option>

            <mat-option *ngFor="let u of filteredCcUsers" [value]="u.id">
              <div class="flex items-center gap-3">
                <img
                  class="h-8 w-8 rounded-full object-cover"
                  [src]="userPhoto(u)"
                  (error)="onImgError($event)"
                  alt="avatar"
                />
                <div class="min-w-0">
                  <div class="truncate font-medium">{{ u.nombre }}</div>
                  <div class="truncate text-xs opacity-60">({{ u.correo || 'sin correo' }})</div>
                </div>
              </div>
            </mat-option>
          </mat-select>
        </mat-form-field>
      }

      <!-- BCC -->
      @if (copyFields.bcc) {
        <mat-form-field>
          <mat-label>Bcc</mat-label>

          <mat-select formControlName="bcc" multiple (selectionChange)="onSelectChange('bcc')">
            <mat-select-trigger>
              <div class="flex flex-wrap gap-2">
                @for (id of composeForm.value.bcc || []; track id) {
                  @if (getUserById(id); as u) {
                    <div class="flex items-center gap-2 rounded-full bg-black/5 px-2 py-1">
                      <img
                        class="h-5 w-5 rounded-full object-cover"
                        [src]="userPhoto(u)"
                        (error)="onImgError($event)"
                        alt="avatar"
                      />
                      <span class="text-sm">{{ u.nombre }}</span>

                      <button
                        type="button"
                        class="ml-1 grid h-5 w-5 place-items-center rounded-full hover:bg-black/10"
                        (click)="removeFrom('bcc', id, $event)"
                        aria-label="Quitar"
                      >
                        ✕
                      </button>
                    </div>
                  }
                }

                @if (!composeForm.value.bcc?.length) {
                  <span class="text-sm opacity-60">Selecciona uno o varios</span>
                }
              </div>
            </mat-select-trigger>

            <mat-option>
              <ngx-mat-select-search
                [formControl]="bccFilterCtrl"
                placeholderLabel="Buscar por nombre o correo..."
                noEntriesFoundLabel="No hay resultados"
              ></ngx-mat-select-search>
            </mat-option>

            <mat-option *ngFor="let u of filteredBccUsers" [value]="u.id">
              <div class="flex items-center gap-3">
                <img
                  class="h-8 w-8 rounded-full object-cover"
                  [src]="userPhoto(u)"
                  (error)="onImgError($event)"
                  alt="avatar"
                />
                <div class="min-w-0">
                  <div class="truncate font-medium">{{ u.nombre }}</div>
                  <div class="truncate text-xs opacity-60">({{ u.correo || 'sin correo' }})</div>
                </div>
              </div>
            </mat-option>
          </mat-select>
        </mat-form-field>
      }

      <!-- Asunto -->
      <mat-form-field>
        <mat-label>Asunto</mat-label>
        <input matInput [formControlName]="'Asunto'" />
      </mat-form-field>

      <!-- Body -->
      <mat-form-field class="mt-2 w-full" appearance="fill">
        <mat-label>Mensaje</mat-label>
        <textarea
          matInput
          rows="2"
          [formControlName]="'body'"
          placeholder="Escribe tu mensaje aquí..."
        ></textarea>
      </mat-form-field>

      <div class="mt-3">
        <div class="mb-2 flex items-center justify-between">
          <div class="text-sm font-medium">
            Adjuntos
            @if (attachedFiles.length) {
              <span
                class="ml-1 rounded-full bg-primary/10 px-2 py-0.5 text-xs text-primary dark:bg-white"
              >
                {{ attachedFiles.length }}
              </span>
            }
          </div>
          <button
            mat-stroked-button
            type="button"
            (click)="attachAny()"
            class="!h-8 !min-h-0 !px-3 !text-xs"
          >
            <mat-icon
              class="mr-1 !h-4 !w-4 !text-base"
              [svgIcon]="'heroicons_outline:paper-clip'"
            ></mat-icon>
            Adjuntar
          </button>
        </div>

        @if (!attachedFiles.length) {
          <div
            class="flex min-h-[60px] items-center justify-center rounded-lg border-2 border-dashed border-black/10 p-3 text-center transition-colors dark:border-gray-100/50"
            (dragover)="onDragOver($event)"
            (dragleave)="onDragLeave($event)"
            (drop)="onDrop($event)"
            [class.border-primary]="isDragging"
          >
            <div class="text-xs opacity-70">
              Arrastra archivos aquí o haz clic en <span class="font-medium">Adjuntar</span>
            </div>
          </div>
        }

        <!-- Lista COMPACTA de adjuntos -->
        @if (attachedFiles.length) {
          <div
            class="space-y-1.5 rounded-lg border border-black/10 bg-black/[0.02] p-2"
            (dragover)="onDragOver($event)"
            (dragleave)="onDragLeave($event)"
            (drop)="onDrop($event)"
            [class.border-primary]="isDragging"
          >
            @for (f of attachedFiles; track f.name + f.size + f.lastModified) {
              <div
                class="group flex items-center gap-2 rounded-md bg-white p-1.5 shadow-sm transition-shadow hover:shadow dark:bg-gray-300/20"
              >
                @if (isImage(f)) {
                  <img
                    class="h-8 w-8 flex-shrink-0 rounded object-cover"
                    [src]="filePreviewUrl(f)"
                    alt="preview"
                  />
                } @else {
                  <div
                    class="grid h-8 w-8 flex-shrink-0 place-items-center rounded bg-black/5 text-[10px] font-bold uppercase"
                  >
                    {{ extOf(f.name) || 'FILE' }}
                  </div>
                }

                <div class="min-w-0 flex-1">
                  <div class="truncate text-xs font-medium">{{ f.name }}</div>
                  <div class="text-[10px] opacity-60">{{ prettySize(f.size) }}</div>
                </div>

                <button
                  mat-icon-button
                  type="button"
                  (click)="removeFile(f)"
                  title="Quitar"
                  class="!h-6 !w-6 flex-shrink-0 opacity-0 transition-opacity group-hover:opacity-100"
                >
                  <mat-icon
                    class="!h-4 !w-4 !text-base dark:text-white"
                    [svgIcon]="'heroicons_outline:x-mark'"
                  ></mat-icon>
                </button>
              </div>
            }
          </div>
        }
      </div>

      <input
        #fileInput
        type="file"
        multiple
        style="display: none"
        (change)="onAnySelected($event)"
        accept="*/*"
      />
    </form>
  </div>

  <!-- FOOTER FIJO -->
  <div
    class="flex-shrink-0 border-t border-black/10 bg-white px-4 py-3 md:px-6 dark:bg-primary-500"
  >
    <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
      <div class="flex flex-col gap-2 md:flex-row md:items-center">
        <button
          class="order-2 text-black md:order-1 dark:bg-gray-100"
          mat-stroked-button
          type="button"
          (click)="Cancelar()"
          [disabled]="isOperationInProgress"
        >
          Cancelar
        </button>

        <button
          class="order-3 md:order-2 dark:bg-gray-100"
          mat-stroked-button
          type="button"
          (click)="BorradorAndClose()"
          [disabled]="!isFormValid || isOperationInProgress"
        >
          @if (isGuardandoBorrador) {
            <ng-container>
              <mat-icon
                class="mr-1 animate-spin"
                [svgIcon]="'heroicons_outline:arrow-path'"
              ></mat-icon>
              <span class="text-black">Guardando...</span>
            </ng-container>
          } @else {
            <span class="text-black">Guardar como borrador</span>
          }
        </button>
        <button
          class="order-1 md:order-3 dark:bg-gray-800"
          mat-flat-button
          [color]="'primary'"
          type="button"
          (click)="enviar()"
          [disabled]="!isFormValid || isOperationInProgress"
        >
          @if (isEnviando) {
            <ng-container>
              <mat-icon
                class="mr-1 animate-spin"
                [svgIcon]="'heroicons_outline:arrow-path'"
              ></mat-icon>
              <span>Enviando...</span>
            </ng-container>
          } @else {
            <span>Enviar</span>
          }
        </button>
      </div>
    </div>
  </div>
</div>
